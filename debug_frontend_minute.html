<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯åˆ†æ—¶å›¾è°ƒè¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { opacity: 0.8; }
        .controls {
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .problem-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .solution-section {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å‰ç«¯åˆ†æ—¶å›¾é—®é¢˜è°ƒè¯•</h1>

        <div class="controls">
            <button onclick="testCorrectData()">âœ… æµ‹è¯•æ­£ç¡®çš„æ•°æ®æ ¼å¼</button>
            <button onclick="testIncorrectData()">âŒ æµ‹è¯•é”™è¯¯çš„æ•°æ®æ ¼å¼</button>
            <button onclick="testRealAPIData()">ğŸŒ æµ‹è¯•çœŸå®APIæ•°æ®</button>
            <button onclick="testLinearData()">ğŸ“ˆ æµ‹è¯•çº¿æ€§å¢é•¿æ•°æ®</button>
            <button onclick="clearChart()">ğŸ—‘ï¸ æ¸…ç©ºå›¾è¡¨</button>
        </div>

        <div class="section">
            <h3>ğŸ“Š åˆ†æ—¶å›¾æ˜¾ç¤º</h3>
            <div id="chart" class="chart-container"></div>
        </div>

        <div class="problem-section">
            <h4>âŒ å¯èƒ½çš„åˆ†æ—¶å›¾é—®é¢˜</h4>
            <ul>
                <li><strong>æ•°æ®æ ¼å¼é—®é¢˜:</strong> minute_dataå­—æ®µç¼ºå¤±æˆ–æ ¼å¼ä¸æ­£ç¡®</li>
                <li><strong>æ—¶é—´æ ¼å¼é—®é¢˜:</strong> æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼ä¸ä¸€è‡´</li>
                <li><strong>ä»·æ ¼æ•°æ®é—®é¢˜:</strong> ä»·æ ¼å…¨ä¸º0æˆ–å¼‚å¸¸å€¼</li>
                <li><strong>æ—¶é—´èŒƒå›´é—®é¢˜:</strong> åªæœ‰ä¸‹åˆæ•°æ®ï¼Œç¼ºå°‘ä¸Šåˆæ•°æ®</li>
                <li><strong>å›¾è¡¨é…ç½®é—®é¢˜:</strong> xAxisæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯</li>
                <li><strong>EChartsç‰ˆæœ¬é—®é¢˜:</strong> ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜</li>
            </ul>
        </div>

        <div class="solution-section">
            <h4>âœ… è§£å†³æ–¹æ¡ˆ</h4>
            <ul>
                <li>æ£€æŸ¥APIè¿”å›çš„minute_dataå­—æ®µæ˜¯å¦åŒ…å«æ­£ç¡®çš„æ•°æ®æ•°ç»„</li>
                <li>ç¡®ä¿æ¯ä¸ªæ•°æ®ç‚¹éƒ½æœ‰time, price, volumeç­‰å¿…è¦å­—æ®µ</li>
                <li>éªŒè¯æ—¶é—´æ ¼å¼ä¸ºHH:MMå­—ç¬¦ä¸²æ ¼å¼</li>
                <li>æ£€æŸ¥ä»·æ ¼æ•°æ®æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ•°å€¼</li>
                <li>ç¡®è®¤å›¾è¡¨åˆå§‹åŒ–æ—¶è®¾ç½®äº†æ­£ç¡®çš„data</li>
            </ul>
        </div>

        <div class="section">
            <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è°ƒè¯•...</div>
        </div>
    </div>

    <script>
        let chart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            chart = echarts.init(document.getElementById('chart'));
            window.addEventListener('resize', () => chart.resize());
        }

        // ç”Ÿæˆæ­£ç¡®çš„æµ‹è¯•æ•°æ®
        function generateCorrectData() {
            const data = [];
            const now = new Date();
            let basePrice = 100;

            // ä¸Šåˆæ•°æ® 9:30-11:30
            for (let hour = 9; hour <= 11; hour++) {
                for (let minute = (hour === 9 ? 30 : 0); minute < 60; minute++) {
                    if (hour === 11 && minute > 30) break;

                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    basePrice += (Math.random() - 0.5) * 2;
                    data.push({
                        time: timeStr,
                        price: Math.max(1, basePrice),
                        volume: Math.floor(Math.random() * 10000) + 1000,
                        amount: basePrice * (Math.random() * 10000 + 1000),
                        avg_price: basePrice,
                        change_percent: ((basePrice - 100) / 100 * 100).toFixed(2)
                    });
                }
            }

            //ä¸‹åˆæ•°æ® 13:00-15:00
            for (let hour = 13; hour <= 15; hour++) {
                for (let minute = 0; minute < 60; minute++) {
                    if (hour === 15 && minute > 0) break;

                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    basePrice += (Math.random() - 0.5) * 2;
                    data.push({
                        time: timeStr,
                        price: Math.max(1, basePrice),
                        volume: Math.floor(Math.random() * 10000) + 1000,
                        amount: basePrice * (Math.random() * 10000 + 1000),
                        avg_price: basePrice,
                        change_percent: ((basePrice - 100) / 100 * 100).toFixed(2)
                    });
                }
            }

            return data;
        }

        // ç”Ÿæˆé”™è¯¯çš„æ•°æ®æ ¼å¼
        function generateIncorrectData() {
            return {
                // é”™è¯¯çš„æ•°æ®ç»“æ„
                status: "success",
                data: [], // ç¼ºå°‘minute_dataå­—æ®µ
                count: 0
            };
        }

        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(minuteData) {
            if (!chart) {
                initChart();
            }

            if (!minuteData || !Array.isArray(minuteData) || minuteData.length === 0) {
                document.getElementById('debugInfo').innerHTML = `
                    <div style="color: red; font-weight: bold;">
                        âŒ åˆ†æ—¶æ•°æ®æ— æ•ˆæˆ–ä¸ºç©º<br>
                        æ•°æ®ç±»å‹: ${typeof minuteData}<br>
                        æ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(minuteData)}<br>
                        æ•°æ®é•¿åº¦: ${minuteData ? minuteData.length : 0}
                    </div>
                `;
                return;
            }

            const times = minuteData.map(item => item.time);
            const prices = minuteData.map(item => item.price || 0);
            const volumes = minuteData.map(item => item.volume || 0);

            const option = {
                title: {
                    text: `æœŸæƒåˆ†æ—¶å›¾ (${minuteData.length}ä¸ªæ•°æ®ç‚¹)`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['ä»·æ ¼', 'æˆäº¤é‡'],
                    top: 30
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 20) // æ˜¾ç¤ºçº¦20ä¸ªæ ‡ç­¾
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ä»·æ ¼',
                        position: 'left',
                        scale: true
                    },
                    {
                        type: 'value',
                        name: 'æˆäº¤é‡',
                        position: 'right',
                        scale: true
                    }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: prices,
                        smooth: true,
                        lineStyle: {
                            width: 2
                        },
                        itemStyle: {
                            color: '#ff4757'
                        }
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: 'rgba(52, 152, 219, 0.6)'
                        }
                    }
                ],
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    }
                ]
            };

            chart.setOption(option, true);

            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            document.getElementById('debugInfo').innerHTML = `
                <div style="color: green; font-weight: bold;">
                    âœ… å›¾è¡¨ç»˜åˆ¶æˆåŠŸ<br>
                    æ•°æ®ç‚¹æ•°: ${minuteData.length}<br>
                    æ—¶é—´èŒƒå›´: ${times[0]} - ${times[times.length - 1]}<br>
                    ä»·æ ¼èŒƒå›´: ${Math.min(...prices).toFixed(2)} - ${Math.max(...prices).toFixed(2)}<br>
                    æˆäº¤é‡èŒƒå›´: ${Math.min(...volumes)} - ${Math.max(...volumes)}
                </div>
            `;
        }

        // æµ‹è¯•æ­£ç¡®çš„æ•°æ®
        function testCorrectData() {
            const data = generateCorrectData();
            drawChart(data);
        }

        // æµ‹è¯•é”™è¯¯çš„æ•°æ®
        function testIncorrectData() {
            const data = generateIncorrectData();
            drawChart(data.minute_data || data.data || []);
        }

        // æµ‹è¯•çœŸå®APIæ•°æ®
        async function testRealAPIData() {
            try {
                const response = await fetch('http://localhost:9000/api/options/MO1000-C-7500/minute');
                const result = await response.json();

                document.getElementById('debugInfo').innerHTML = `
                    <strong>APIå“åº”çŠ¶æ€:</strong> ${response.ok ? 'æˆåŠŸ' : 'å¤±è´¥'}<br>
                    <strong>æ•°æ®çŠ¶æ€:</strong> ${result.status}<br>
                    <strong>æ•°æ®ç»“æ„:</strong> ${JSON.stringify(Object.keys(result), null, 2)}<br>
                    <strong>minute_dataå­˜åœ¨:</strong> ${result.hasOwnProperty('minute_data')}<br>
                    <strong>dataå­˜åœ¨:</strong> ${result.hasOwnProperty('data')}<br>
                    <strong>minute_dataé•¿åº¦:</strong> ${result.minute_data ? result.minute_data.length : 0}<br>
                    <strong>dataé•¿åº¦:</strong> ${result.data ? result.data.length : 0}
                `;

                // å°è¯•ç»˜åˆ¶
                const minuteData = result.minute_data || result.data || [];
                drawChart(minuteData);

            } catch (error) {
                document.getElementById('debugInfo').innerHTML = `
                    <div style="color: red;">
                        âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•çº¿æ€§æ•°æ®
        function testLinearData() {
            const data = [];
            let basePrice = 50;

            for (let i = 0; i < 240; i++) {
                const hour = Math.floor(9.5 + i / 60);
                const minute = (i % 60);
                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                basePrice += 0.1; // çº¿æ€§å¢é•¿
                data.push({
                    time: timeStr,
                    price: basePrice,
                    volume: Math.floor(Math.random() * 5000) + 1000,
                    amount: basePrice * (Math.random() * 5000 + 1000),
                    avg_price: basePrice,
                    change_percent: ((basePrice - 50) / 50 * 100).toFixed(2)
                });
            }

            drawChart(data);
        }

        // æ¸…ç©ºå›¾è¡¨
        function clearChart() {
            if (chart) {
                chart.clear();
            }
            document.getElementById('debugInfo').innerHTML = 'å›¾è¡¨å·²æ¸…ç©º';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
        });
    </script>
</body>
</html>