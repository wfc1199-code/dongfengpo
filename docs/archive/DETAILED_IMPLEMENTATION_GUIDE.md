# ä¸œé£ç ´æ ¸å¿ƒåŠŸèƒ½è¯¦ç»†å®ç°æŒ‡å—

> æ·±å…¥è§£æ4ä¸ªæ ¸å¿ƒæŠ€æœ¯æ£€æµ‹åŠŸèƒ½çš„ç®—æ³•åŸç†å’Œå®ç°ç»†èŠ‚

---

## ğŸ“Š åŠŸèƒ½ä¸€ï¼šæ¨ªç›˜çªç ´æ£€æµ‹

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

**ä»€ä¹ˆæ˜¯æ¨ªç›˜ï¼Ÿ**
- è‚¡ç¥¨ä»·æ ¼åœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆå¦‚30åˆ†é’Ÿï¼‰åœ¨å°èŒƒå›´å†…æ³¢åŠ¨ï¼ˆå¦‚Â±3%ï¼‰
- æˆäº¤é‡ç›¸å¯¹å¹³ç¨³
- æ²¡æœ‰æ˜æ˜¾çš„ä¸Šæ¶¨æˆ–ä¸‹è·Œè¶‹åŠ¿

**ä»€ä¹ˆæ˜¯æ¨ªç›˜çªç ´ï¼Ÿ**
- ä»·æ ¼çªç„¶å‘ä¸Šçªç ´æ¨ªç›˜åŒºé—´
- ä¼´éšæˆäº¤é‡æ˜¾è‘—æ”¾å¤§ï¼ˆé‡æ¯” > 2å€ï¼‰
- é€šå¸¸é¢„ç¤ºä¸»åŠ›å¼€å§‹æ‹‰å‡

**æŠ€æœ¯æ„ä¹‰**ï¼š
æ¨ªç›˜æ˜¯ä¸»åŠ›å¸ç­¹æˆ–æ´—ç›˜çš„å¸¸è§æ‰‹æ³•ï¼Œçªç ´æ¨ªç›˜å¾€å¾€æ˜¯æ‹‰å‡çš„å¼€å§‹ä¿¡å·ã€‚

---

### 1.2 ç®—æ³•æµç¨‹å›¾

```
è¾“å…¥ï¼šè‚¡ç¥¨ä»£ç 
    â†“
è·å–æœ€è¿‘60åˆ†é’Ÿåˆ†æ—¶æ•°æ®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯†åˆ«æ¨ªç›˜é˜¶æ®µ           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1. æ»‘åŠ¨çª—å£ï¼ˆ30åˆ†é’Ÿï¼‰  â”‚
â”‚  2. è®¡ç®—ä»·æ ¼æ³¢åŠ¨èŒƒå›´    â”‚
â”‚  3. åˆ¤æ–­æ˜¯å¦ â‰¤ 3%      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ‰¾åˆ°æ‰€æœ‰æ¨ªç›˜åŒºé—´
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ¤æ–­æ˜¯å¦çªç ´           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1. å½“å‰ä»· > æ¨ªç›˜é«˜ç‚¹   â”‚
â”‚  2. çªç ´å¹…åº¦ > 2%      â”‚
â”‚  3. æˆäº¤é‡æ”¾å¤§ > 2å€    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è®¡ç®—çªç ´å¼ºåº¦ï¼ˆ0-100åˆ†ï¼‰
    â†“
è¿”å›æ£€æµ‹ç»“æœ
```

---

### 1.3 è¯¦ç»†ç®—æ³•å®ç°

#### æ­¥éª¤1ï¼šæ•°æ®å‡†å¤‡

```python
async def get_timeshare_data(stock_code: str, minutes: int = 60):
    """
    è·å–åˆ†æ—¶æ•°æ®
    
    Returns: [
        {
            'time': '09:30:00',
            'price': 15.20,
            'volume': 100000,
            'amount': 1520000,
            'avg_price': 15.18
        },
        ...
    ]
    """
    # ä»æ•°æ®æºè·å–
    data = await data_source.get_minute_data(stock_code)
    
    # å–æœ€è¿‘Nåˆ†é’Ÿ
    return data[-minutes:]
```

#### æ­¥éª¤2ï¼šè¯†åˆ«æ¨ªç›˜é˜¶æ®µ

**æ ¸å¿ƒç®—æ³•ï¼šæ»‘åŠ¨çª—å£ä»·æ ¼æ³¢åŠ¨æ£€æµ‹**

```python
def _find_consolidation_periods(self, timeshare: list) -> list:
    """
    è¯†åˆ«æ¨ªç›˜é˜¶æ®µ
    
    ç®—æ³•è¯¦è§£ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ»‘åŠ¨çª—å£ç¤ºæ„å›¾                   â”‚
    â”‚                                   â”‚
    â”‚  ä»·æ ¼  15.5 â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€  â”‚
    â”‚       15.3 â”€â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”¬â”€  â”‚
    â”‚       15.1 â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”  â”‚
    â”‚       14.9 â”€â”˜                 â””â”€  â”‚
    â”‚              â””â”€ 30åˆ†é’Ÿçª—å£ â”€â”˜    â”‚
    â”‚                                   â”‚
    â”‚  æ³¢åŠ¨èŒƒå›´ = (15.5-14.9)/14.9     â”‚
    â”‚           = 4.03% > 3% âŒ        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    periods = []
    window_size = self.config['consolidation_minutes']  # 30
    threshold = self.config['consolidation_range']      # 3.0%
    
    for i in range(len(timeshare) - window_size):
        # è·å–çª—å£æ•°æ®
        window = timeshare[i:i + window_size]
        
        # æå–ä»·æ ¼
        prices = [item['price'] for item in window]
        volumes = [item['volume'] for item in window]
        
        # è®¡ç®—æ³¢åŠ¨èŒƒå›´
        high = max(prices)
        low = min(prices)
        price_range = (high - low) / low * 100
        
        # åˆ¤æ–­æ˜¯å¦æ¨ªç›˜
        if price_range <= threshold:
            periods.append({
                'start_idx': i,
                'end_idx': i + window_size - 1,
                'start_time': window[0]['time'],
                'end_time': window[-1]['time'],
                'duration': window_size,
                'price_high': high,
                'price_low': low,
                'price_mid': (high + low) / 2,
                'price_range': price_range,
                'avg_volume': sum(volumes) / len(volumes),
                'total_volume': sum(volumes),
                'prices': prices,
                'volumes': volumes
            })
    
    # åˆå¹¶ç›¸é‚»çš„æ¨ªç›˜åŒºé—´
    merged = self._merge_consolidation_periods(periods)
    
    return merged
```

**åˆå¹¶ç›¸é‚»åŒºé—´**ï¼š

```python
def _merge_consolidation_periods(self, periods: list) -> list:
    """
    åˆå¹¶ç›¸é‚»æˆ–é‡å çš„æ¨ªç›˜åŒºé—´
    
    ç¤ºä¾‹ï¼š
    åŒºé—´1: [09:30 - 10:00]  â”€â”€â”€â”€â”€â”
    åŒºé—´2: [09:45 - 10:15]      â”œâ”€â†’ åˆå¹¶ä¸º [09:30 - 10:15]
    åŒºé—´3: [09:50 - 10:20]  â”€â”€â”€â”€â”€â”˜
    """
    if not periods:
        return []
    
    # æŒ‰å¼€å§‹æ—¶é—´æ’åº
    sorted_periods = sorted(periods, key=lambda p: p['start_idx'])
    
    merged = [sorted_periods[0]]
    
    for current in sorted_periods[1:]:
        last = merged[-1]
        
        # æ£€æŸ¥æ˜¯å¦é‡å æˆ–ç›¸é‚»ï¼ˆå…è®¸5åˆ†é’Ÿé—´éš”ï¼‰
        if current['start_idx'] <= last['end_idx'] + 5:
            # åˆå¹¶
            merged[-1] = {
                'start_idx': last['start_idx'],
                'end_idx': max(last['end_idx'], current['end_idx']),
                'start_time': last['start_time'],
                'end_time': current['end_time'],
                'duration': max(last['end_idx'], current['end_idx']) - last['start_idx'] + 1,
                'price_high': max(last['price_high'], current['price_high']),
                'price_low': min(last['price_low'], current['price_low']),
                'price_mid': (max(last['price_high'], current['price_high']) + 
                             min(last['price_low'], current['price_low'])) / 2,
                'price_range': (max(last['price_high'], current['price_high']) - 
                               min(last['price_low'], current['price_low'])) / 
                               min(last['price_low'], current['price_low']) * 100,
                'avg_volume': (last['avg_volume'] * last['duration'] + 
                              current['avg_volume'] * current['duration']) / 
                              (last['duration'] + current['duration']),
                'total_volume': last['total_volume'] + current['total_volume'],
                'prices': last['prices'] + current['prices'],
                'volumes': last['volumes'] + current['volumes']
            }
        else:
            merged.append(current)
    
    return merged
```

#### æ­¥éª¤3ï¼šåˆ¤æ–­çªç ´

```python
def _is_breakout(self, period: dict, current: dict) -> bool:
    """
    åˆ¤æ–­æ˜¯å¦çªç ´æ¨ªç›˜
    
    çªç ´æ¡ä»¶ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¡ä»¶1: ä»·æ ¼çªç ´                      â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  å½“å‰ä»· > æ¨ªç›˜é«˜ç‚¹ + çªç ´é˜ˆå€¼(2%)     â”‚
    â”‚                                       â”‚
    â”‚  ç¤ºä¾‹ï¼š                               â”‚
    â”‚  æ¨ªç›˜é«˜ç‚¹ = 15.50                    â”‚
    â”‚  çªç ´ä»·ä½ = 15.50 * 1.02 = 15.81    â”‚
    â”‚  å½“å‰ä»· = 15.85 âœ“                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¡ä»¶2: é‡èƒ½çªç ´                      â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  å½“å‰æˆäº¤é‡ > æ¨ªç›˜å¹³å‡é‡ * é‡æ¯”(2å€) â”‚
    â”‚                                       â”‚
    â”‚  ç¤ºä¾‹ï¼š                               â”‚
    â”‚  æ¨ªç›˜å¹³å‡é‡ = 200,000æ‰‹              â”‚
    â”‚  çªç ´é‡èƒ½ = 200,000 * 2 = 400,000   â”‚
    â”‚  å½“å‰æˆäº¤é‡ = 520,000 âœ“             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    # æ¡ä»¶1ï¼šä»·æ ¼çªç ´
    breakout_price = period['price_high'] * (1 + self.config['breakout_threshold'] / 100)
    price_breakout = current['price'] >= breakout_price
    
    # æ¡ä»¶2ï¼šé‡èƒ½çªç ´
    required_volume = period['avg_volume'] * self.config['breakout_volume_ratio']
    volume_breakout = current['volume'] >= required_volume
    
    # é¢å¤–æ£€æŸ¥ï¼šçªç ´æ˜¯å¦æœ‰åŠ›åº¦
    breakout_percent = (current['price'] - period['price_high']) / period['price_high'] * 100
    volume_ratio = current['volume'] / period['avg_volume']
    
    # æ—¥å¿—è®°å½•
    logger.debug(f"""
    çªç ´æ£€æµ‹:
    - ä»·æ ¼çªç ´: {price_breakout} (å½“å‰{current['price']:.2f} vs éœ€è¦{breakout_price:.2f})
    - é‡èƒ½çªç ´: {volume_breakout} (å½“å‰{current['volume']} vs éœ€è¦{required_volume:.0f})
    - çªç ´å¹…åº¦: {breakout_percent:.2f}%
    - é‡æ¯”å€æ•°: {volume_ratio:.2f}x
    """)
    
    return price_breakout and volume_breakout
```

#### æ­¥éª¤4ï¼šè®¡ç®—çªç ´å¼ºåº¦

```python
def _calculate_strength(self, period: dict, current: dict) -> int:
    """
    è®¡ç®—çªç ´å¼ºåº¦ï¼ˆ0-100åˆ†ï¼‰
    
    è¯„åˆ†ç»´åº¦ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. æ¨ªç›˜æ—¶é•¿ (25åˆ†)                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  æ—¶é•¿è¶Šé•¿ï¼Œçªç ´è¶Šæœ‰æ„ä¹‰               â”‚
    â”‚  30åˆ†é’Ÿ = 12.5åˆ†                     â”‚
    â”‚  60åˆ†é’Ÿ = 25åˆ†ï¼ˆæ»¡åˆ†ï¼‰               â”‚
    â”‚                                       â”‚
    â”‚  å…¬å¼: min(æ—¶é•¿/60 * 25, 25)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  2. çªç ´å¹…åº¦ (25åˆ†)                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  çªç ´å¹…åº¦è¶Šå¤§ï¼ŒåŠ›åº¦è¶Šå¼º               â”‚
    â”‚  2% = 10åˆ†                           â”‚
    â”‚  5% = 25åˆ†ï¼ˆæ»¡åˆ†ï¼‰                   â”‚
    â”‚                                       â”‚
    â”‚  å…¬å¼: min(çªç ´%/5 * 25, 25)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  3. é‡èƒ½æ”¾å¤§ (25åˆ†)                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  é‡æ¯”è¶Šå¤§ï¼Œä¸»åŠ›è¶Šæ˜æ˜¾                 â”‚
    â”‚  2å€ = 12.5åˆ†                        â”‚
    â”‚  3å€ = 25åˆ†ï¼ˆæ»¡åˆ†ï¼‰                  â”‚
    â”‚                                       â”‚
    â”‚  å…¬å¼: min((é‡æ¯”-1)/2 * 25, 25)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  4. æ¨ªç›˜ç¨³å®šæ€§ (25åˆ†)                 â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚  æ³¢åŠ¨è¶Šå°ï¼Œæ¨ªç›˜è¶Šç¨³å®š                 â”‚
    â”‚  1% = 20åˆ†                           â”‚
    â”‚  3% = 0åˆ†                            â”‚
    â”‚                                       â”‚
    â”‚  å…¬å¼: (1 - æ³¢åŠ¨%/5) * 25            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    
    # 1. æ¨ªç›˜æ—¶é•¿åˆ†æ•°ï¼ˆ0-25ï¼‰
    duration_score = min(period['duration'] / 60 * 25, 25)
    
    # 2. çªç ´å¹…åº¦åˆ†æ•°ï¼ˆ0-25ï¼‰
    breakout_percent = (current['price'] - period['price_high']) / period['price_high'] * 100
    breakout_score = min(breakout_percent / 5 * 25, 25)
    
    # 3. é‡èƒ½æ”¾å¤§åˆ†æ•°ï¼ˆ0-25ï¼‰
    volume_ratio = current['volume'] / period['avg_volume']
    volume_score = min((volume_ratio - 1) / 2 * 25, 25)
    
    # 4. æ¨ªç›˜ç¨³å®šæ€§åˆ†æ•°ï¼ˆ0-25ï¼‰
    stability_score = max(0, (1 - period['price_range'] / 5) * 25)
    
    # æ€»åˆ†
    total_score = duration_score + breakout_score + volume_score + stability_score
    
    # æ—¥å¿—è¯¦ç»†è¯„åˆ†
    logger.info(f"""
    çªç ´å¼ºåº¦è¯„åˆ†:
    â”œâ”€ æ¨ªç›˜æ—¶é•¿: {period['duration']}åˆ†é’Ÿ â†’ {duration_score:.1f}åˆ†
    â”œâ”€ çªç ´å¹…åº¦: {breakout_percent:.2f}% â†’ {breakout_score:.1f}åˆ†
    â”œâ”€ é‡èƒ½æ”¾å¤§: {volume_ratio:.2f}å€ â†’ {volume_score:.1f}åˆ†
    â”œâ”€ æ¨ªç›˜ç¨³å®š: {period['price_range']:.2f}% â†’ {stability_score:.1f}åˆ†
    â””â”€ æ€»åˆ†: {total_score:.1f}/100
    """)
    
    return int(max(0, min(100, total_score)))
```

---

### 1.4 å®æˆ˜æ¡ˆä¾‹åˆ†æ

**æ¡ˆä¾‹ï¼šå¤©é¾™å…‰ç”µï¼ˆ300123ï¼‰æ¨ªç›˜çªç ´**

```
æ—¶é—´çº¿ï¼š
09:30 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¼€ç›˜ 15.20
09:35 â”€â”€â”
09:40 â”€â”€â”¤
09:45 â”€â”€â”¤ æ¨ªç›˜é˜¶æ®µï¼ˆæ³¢åŠ¨Â±2.5%ï¼‰
09:50 â”€â”€â”¤ å¹³å‡æˆäº¤é‡ï¼š200,000æ‰‹
09:55 â”€â”€â”¤
10:00 â”€â”€â”˜ æ¨ªç›˜é«˜ç‚¹ï¼š15.50
10:05 â”€â”€â”€â”€ çªç ´å¼€å§‹ï¼ä»·æ ¼ï¼š15.85 (+2.26%)
           æˆäº¤é‡ï¼š520,000æ‰‹ (2.6å€)
           
æ£€æµ‹ç»“æœï¼š
â”œâ”€ æ¨ªç›˜æ—¶é•¿: 30åˆ†é’Ÿ â†’ 12.5åˆ†
â”œâ”€ çªç ´å¹…åº¦: 2.26% â†’ 11.3åˆ†
â”œâ”€ é‡èƒ½æ”¾å¤§: 2.6å€ â†’ 20åˆ†
â”œâ”€ æ¨ªç›˜ç¨³å®š: 2.5% â†’ 12.5åˆ†
â””â”€ æ€»åˆ†: 56.3/100 â†’ ä¸­ç­‰å¼ºåº¦çªç ´
```

---

### 1.5 å‚æ•°è°ƒä¼˜æŒ‡å—

| å‚æ•° | é»˜è®¤å€¼ | å»ºè®®èŒƒå›´ | è¯´æ˜ |
|------|--------|----------|------|
| consolidation_range | 3.0% | 2-5% | æ¨ªç›˜æ³¢åŠ¨é˜ˆå€¼ï¼Œè¶Šå°è¶Šä¸¥æ ¼ |
| consolidation_minutes | 30 | 20-60 | æ¨ªç›˜æ—¶é•¿ï¼Œè¶Šé•¿è¶Šå¯é  |
| breakout_volume_ratio | 2.0 | 1.5-3.0 | çªç ´é‡æ¯”ï¼Œè¶Šå¤§è¶Šæ˜æ˜¾ |
| breakout_threshold | 2.0% | 1-3% | çªç ´å¹…åº¦ï¼Œè¶Šå¤§è¶Šå®‰å…¨ |

**è°ƒä¼˜å»ºè®®**ï¼š
- **æ¿€è¿›ç­–ç•¥**ï¼šèŒƒå›´4%ï¼Œæ—¶é•¿20åˆ†é’Ÿï¼Œé‡æ¯”1.5å€ â†’ æ•è·æ›´å¤šä¿¡å·ï¼Œä½†è¯¯æŠ¥ç‡é«˜
- **ç¨³å¥ç­–ç•¥**ï¼šèŒƒå›´2%ï¼Œæ—¶é•¿45åˆ†é’Ÿï¼Œé‡æ¯”2.5å€ â†’ ä¿¡å·å°‘ä½†å‡†ç¡®ç‡é«˜
- **å¹³è¡¡ç­–ç•¥**ï¼šèŒƒå›´3%ï¼Œæ—¶é•¿30åˆ†é’Ÿï¼Œé‡æ¯”2.0å€ â†’ æ¨èé…ç½®

---

## ğŸ”„ åŠŸèƒ½äºŒï¼šå¼‚åŠ¨çŠ¶æ€æœº

### 2.1 çŠ¶æ€è®¾è®¡

**5ä¸ªæ ¸å¿ƒçŠ¶æ€**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             å¼‚åŠ¨çŠ¶æ€è½¬æ¢å›¾                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚    â”‚ ç©ºé—² â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â””â”€â”€â”€â”¬â”€â”€â”˜             â”‚                   â”‚
â”‚        â”‚ æ£€æµ‹åˆ°å¼‚åŠ¨      â”‚ å›è½/å¹³ç¨³        â”‚
â”‚        â–¼                â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                   â”‚
â”‚    â”‚ å¼€å§‹æ‹‰å‡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚                   â”‚
â”‚          â”‚ 5åˆ†é’Ÿå†…      â”‚                   â”‚
â”‚          â”‚ å†æ¬¡å¼‚åŠ¨      â”‚                   â”‚
â”‚          â–¼              â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                   â”‚
â”‚    â”‚ æŒç»­æ‹‰å‡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚                   â”‚
â”‚          â”‚ æ¶¨å¹… > 8%    â”‚                   â”‚
â”‚          â–¼              â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                   â”‚
â”‚    â”‚ å¿«è¦æ¶¨åœ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚                   â”‚
â”‚          â”‚ æ¶¨å¹… > 9.8%  â”‚                   â”‚
â”‚          â–¼              â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                   â”‚
â”‚    â”‚ å·²æ¶¨åœ   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                              â”‚
â”‚  ä»»æ„çŠ¶æ€ â”€â”€ä»·æ ¼å›è½>2%â”€â”€â†’ å†²é«˜å›è½ â”€â”€â†’ ç©ºé—² â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 çŠ¶æ€è½¬æ¢è¯¦è§£

#### è½¬æ¢1: ç©ºé—² â†’ å¼€å§‹æ‹‰å‡

```python
è§¦å‘æ¡ä»¶ï¼š
1. æ£€æµ‹åˆ°å¼‚åŠ¨ï¼ˆæ¶¨å¹…å¢é€Ÿè¶…è¿‡é˜ˆå€¼ï¼‰
2. ä¹‹å‰æ²¡æœ‰å¼‚åŠ¨è®°å½•ï¼Œæˆ–è·ç¦»ä¸Šæ¬¡å¼‚åŠ¨ > 5åˆ†é’Ÿ

ä»£ç å®ç°ï¼š
if data.get('is_anomaly'):
    last_anomaly = self._get_last_anomaly(stock_code)
    
    if not last_anomaly:
        # ç¬¬ä¸€æ¬¡å¼‚åŠ¨
        return AnomalyState.STARTING
    
    time_diff = (data['timestamp'] - last_anomaly['timestamp']).total_seconds()
    if time_diff > 300:  # 5åˆ†é’Ÿ
        # æ–°ä¸€æ³¢å¼‚åŠ¨å¼€å§‹
        return AnomalyState.STARTING

æŠ¥è­¦ï¼šâœ“ è§¦å‘"å¼€å§‹æ‹‰å‡"æŠ¥è­¦
```

**å®æˆ˜æ¡ˆä¾‹**ï¼š
```
10:23:15 - æ£€æµ‹åˆ°å¼‚åŠ¨
         - æ¶¨å¹…ä» +2.3% â†’ +5.1%ï¼ˆå¢é€Ÿ3.8%/åˆ†é’Ÿï¼‰
         - è·ç¦»ä¸Šæ¬¡å¼‚åŠ¨ 6åˆ†é’Ÿ
         - åˆ¤å®šï¼šå¼€å§‹æ‹‰å‡ âœ“
         - è§¦å‘æŠ¥è­¦ï¼šã€å¼€å§‹æ‹‰å‡ã€‘300123 å¤©é¾™å…‰ç”µ +5.1%
```

#### è½¬æ¢2: å¼€å§‹æ‹‰å‡ â†’ æŒç»­æ‹‰å‡

```python
è§¦å‘æ¡ä»¶ï¼š
1. å½“å‰å¤„äº"å¼€å§‹æ‹‰å‡"çŠ¶æ€
2. 5åˆ†é’Ÿå†…å†æ¬¡æ£€æµ‹åˆ°å¼‚åŠ¨
3. ä»·æ ¼æŒç»­ä¸Šæ¶¨ï¼ˆå½“å‰ä»· > ä¸Šæ¬¡å¼‚åŠ¨ä»·ï¼‰

ä»£ç å®ç°ï¼š
if current_state == AnomalyState.STARTING:
    if data.get('is_anomaly'):
        time_diff = (data['timestamp'] - last_anomaly['timestamp']).total_seconds()
        if time_diff <= 300:  # 5åˆ†é’Ÿå†…
            return AnomalyState.CONTINUING

æŠ¥è­¦ï¼šâœ— ä¸è§¦å‘æŠ¥è­¦ï¼ˆé¿å…é¢‘ç¹æŠ¥è­¦ï¼‰
```

#### è½¬æ¢3: æŒç»­æ‹‰å‡ â†’ å¿«è¦æ¶¨åœ

```python
è§¦å‘æ¡ä»¶ï¼š
1. æ¶¨å¹…è¶…è¿‡é˜ˆå€¼
   - ä¸»æ¿/ä¸­å°æ¿ï¼š> 8%
   - åˆ›ä¸šæ¿/ç§‘åˆ›æ¿ï¼š> 18%

ä»£ç å®ç°ï¼š
is_gem = self._is_gem_or_star_market(stock_code)
threshold = 18.0 if is_gem else 8.0

if data['change_percent'] >= threshold:
    return AnomalyState.NEAR_LIMIT

æŠ¥è­¦ï¼šâœ“ è§¦å‘"å¿«è¦æ¶¨åœ"æŠ¥è­¦
```

#### è½¬æ¢4: å¿«è¦æ¶¨åœ â†’ å·²æ¶¨åœ

```python
è§¦å‘æ¡ä»¶ï¼š
1. æ¶¨å¹…è¾¾åˆ°æ¶¨åœé˜ˆå€¼
   - ä¸»æ¿/ä¸­å°æ¿ï¼šâ‰¥ 9.8%
   - åˆ›ä¸šæ¿/ç§‘åˆ›æ¿ï¼šâ‰¥ 19.8%

ä»£ç å®ç°ï¼š
limit_threshold = 19.8 if is_gem else 9.8

if data['change_percent'] >= limit_threshold:
    return AnomalyState.LIMIT_UP

æŠ¥è­¦ï¼šâœ— ä¸è§¦å‘æŠ¥è­¦ï¼ˆå·²ç»æ¶¨åœï¼‰
```

#### è½¬æ¢5: ä»»æ„çŠ¶æ€ â†’ å†²é«˜å›è½

```python
è§¦å‘æ¡ä»¶ï¼š
1. ä»·æ ¼ä»æœ€é«˜ç‚¹å›è½è¶…è¿‡2%
2. ä¹‹å‰å¤„äºæ‹‰å‡çŠ¶æ€

ä»£ç å®ç°ï¼š
def _is_falling(self, stock_code: str, data: dict) -> bool:
    """åˆ¤æ–­æ˜¯å¦å†²é«˜å›è½"""
    # è·å–ä»Šæ—¥æœ€é«˜ä»·
    highest = self._get_today_highest_price(stock_code)
    
    if not highest:
        return False
    
    # è®¡ç®—å›è½å¹…åº¦
    fallback_percent = (highest - data['price']) / highest * 100
    
    return fallback_percent >= 2.0

æŠ¥è­¦ï¼šâœ— ä¸è§¦å‘æŠ¥è­¦
```

---

### 2.3 è¿ç»­å¼‚åŠ¨ç»Ÿè®¡

#### æŒ‡æ ‡1ï¼šè¿ç»­æ‹‰ï¼ˆè¿ç»­å¼‚åŠ¨æ¬¡æ•°ï¼‰

```python
def _count_continuous_anomalies(self, stock_code: str) -> int:
    """
    ç»Ÿè®¡è¿ç»­å¼‚åŠ¨æ¬¡æ•°
    
    ç®—æ³•ï¼šä»æœ€è¿‘çš„å¼‚åŠ¨å¾€å‰å›æº¯ï¼Œåªè¦æ—¶é—´é—´éš” â‰¤ 5åˆ†é’Ÿå°±ç®—è¿ç»­
    
    ç¤ºä¾‹ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å¼‚åŠ¨æ—¶é—´çº¿                            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 10:25 â”€â”€â”                            â”‚
    â”‚ 10:28 â”€â”€â”¤                            â”‚
    â”‚ 10:32 â”€â”€â”¤ è¿ç»­4æ¬¡ï¼ˆé—´éš”éƒ½ â‰¤ 5åˆ†é’Ÿï¼‰  â”‚
    â”‚ 10:35 â”€â”€â”˜                            â”‚
    â”‚                                       â”‚
    â”‚ 10:42 â”€â”€â”€â”€ é—´éš”7åˆ†é’Ÿï¼Œä¸è¿ç»­          â”‚
    â”‚ 10:45 â”€â”€â”€â”€ æ–°çš„è¿ç»­å¼€å§‹               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    anomalies = self.anomaly_history.get(stock_code, [])
    
    if not anomalies:
        return 0
    
    continuous = 1  # æœ€è¿‘ä¸€æ¬¡ç®—1æ¬¡
    
    # ä»æœ€æ–°å¾€å‰éå†
    for i in range(len(anomalies) - 1, 0, -1):
        current = anomalies[i]
        previous = anomalies[i - 1]
        
        # è®¡ç®—æ—¶é—´é—´éš”
        time_diff = (current['timestamp'] - previous['timestamp']).total_seconds()
        
        if time_diff <= 300:  # 5åˆ†é’Ÿå†…
            continuous += 1
        else:
            break  # ä¸è¿ç»­ï¼Œåœæ­¢ç»Ÿè®¡
    
    return continuous
```

**å®æˆ˜ç¤ºä¾‹**ï¼š
```
è‚¡ç¥¨ï¼š300123 å¤©é¾™å…‰ç”µ

å¼‚åŠ¨è®°å½•ï¼š
10:20 +3.2%  â”
10:23 +5.1%  â”‚
10:25 +6.8%  â”œâ”€ è¿ç»­5æ¬¡
10:28 +7.9%  â”‚
10:30 +8.5%  â”˜

10:38 +9.1%  â† é—´éš”8åˆ†é’Ÿï¼Œä¸è¿ç»­

ç»Ÿè®¡ç»“æœï¼šè¿ç»­æ‹‰ = 5
```

#### æŒ‡æ ‡2ï¼šåæ‹‰å‡ ï¼ˆæœ€è¿‘10æ¬¡ä¸­å¼‚åŠ¨æ¬¡æ•°ï¼‰

```python
def get_last_10_anomalies_count(self, stock_code: str) -> dict:
    """
    ç»Ÿè®¡æœ€è¿‘10æ¬¡ä¸­å¼‚åŠ¨æ¬¡æ•°
    
    ç›®çš„ï¼šé¿å…å› å¶ç„¶ä¸­æ–­å¯¼è‡´çš„è¿ç»­è®¡æ•°å½’é›¶
    
    ç¤ºä¾‹ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æœ€è¿‘12æ¬¡ä»·æ ¼å˜åŠ¨                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ #1  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #2  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #3  å¹³ç¨³ âœ—  â† è¿ç»­ä¸­æ–­               â”‚
    â”‚ #4  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #5  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #6  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #7  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #8  å¹³ç¨³ âœ—                           â”‚
    â”‚ #9  å¼‚åŠ¨ âœ“                           â”‚
    â”‚ #10 å¼‚åŠ¨ âœ“                           â”‚
    â”‚                                       â”‚
    â”‚ è¿ç»­æ‹‰ = 2ï¼ˆ#9-#10ï¼‰                 â”‚
    â”‚ åæ‹‰å‡  = 8ï¼ˆ10æ¬¡ä¸­8æ¬¡å¼‚åŠ¨ï¼‰          â”‚
    â”‚                                       â”‚
    â”‚ â†’ è™½ç„¶è¿ç»­ä¸­æ–­ï¼Œä½†æ•´ä½“å¾ˆå¼ºåŠ¿ï¼       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    anomalies = self.anomaly_history.get(stock_code, [])
    
    if not anomalies:
        return {'last_10_count': 0, 'total_count': 0}
    
    # è·å–æœ€è¿‘10æ¬¡
    last_10 = anomalies[-10:] if len(anomalies) >= 10 else anomalies
    
    # ç»Ÿè®¡å¼‚åŠ¨æ¬¡æ•°
    anomaly_count = len(last_10)
    
    return {
        'last_10_count': anomaly_count,
        'total_count': len(anomalies),
        'rate': anomaly_count / 10 if len(last_10) == 10 else None
    }
```

---

### 2.4 çŠ¶æ€å­˜å‚¨ç»“æ„

```python
# å†…å­˜å­˜å‚¨ç»“æ„
class AnomalyStateMachine:
    def __init__(self):
        # å½“å‰çŠ¶æ€
        self.states = {
            '300123': AnomalyState.CONTINUING,
            '000001': AnomalyState.IDLE,
            ...
        }
        
        # å¼‚åŠ¨å†å²
        self.anomaly_history = {
            '300123': [
                {
                    'timestamp': datetime(2025, 1, 13, 10, 25),
                    'price': 15.68,
                    'change_percent': 5.1,
                    'volume': 500000,
                    'change_speed': 3.8  # æ¶¨å¹…å¢é€Ÿ
                },
                {
                    'timestamp': datetime(2025, 1, 13, 10, 28),
                    'price': 15.95,
                    'change_percent': 6.8,
                    'volume': 620000,
                    'change_speed': 4.2
                },
                ...
            ]
        }
        
        # çŠ¶æ€å˜åŒ–å†å²
        self.state_history = {
            '300123': [
                {
                    'timestamp': datetime(2025, 1, 13, 10, 25),
                    'old_state': 'IDLE',
                    'new_state': 'STARTING',
                    'price': 15.68,
                    'change_percent': 5.1,
                    'trigger': 'æ£€æµ‹åˆ°ç¬¬ä¸€æ¬¡å¼‚åŠ¨'
                },
                {
                    'timestamp': datetime(2025, 1, 13, 10, 28),
                    'old_state': 'STARTING',
                    'new_state': 'CONTINUING',
                    'price': 15.95,
                    'change_percent': 6.8,
                    'trigger': '5åˆ†é’Ÿå†…å†æ¬¡å¼‚åŠ¨'
                },
                ...
            ]
        }
```

---

## ğŸ”ï¸ åŠŸèƒ½ä¸‰ï¼šç ´å³°çªç ´æ£€æµ‹

### 3.1 æ ¸å¿ƒæ¦‚å¿µ

**ä»€ä¹ˆæ˜¯å³°å€¼ï¼Ÿ**
- åˆ†æ—¶å›¾ä¸Šçš„å±€éƒ¨æœ€é«˜ç‚¹
- å‰åä¸€å®šèŒƒå›´å†…ï¼ˆå¦‚5åˆ†é’Ÿï¼‰éƒ½æ²¡æœ‰æ›´é«˜çš„ä»·æ ¼

**ä»€ä¹ˆæ˜¯ç ´å³°ï¼Ÿ**
- è‚¡ç¥¨ä»·æ ¼çªç ´å½“æ—¥æœ€é«˜å³°å€¼
- é€šå¸¸æ„å‘³ç€çªç ´å‰æœŸå‹åŠ›ä½
- å¯èƒ½å¼€å¯æ–°ä¸€è½®ä¸Šæ¶¨

---

### 3.2 å³°å€¼è¯†åˆ«ç®—æ³•

#### ç®—æ³•1ï¼šæ»‘åŠ¨çª—å£å±€éƒ¨æå€¼æ³•

```python
def _find_peaks(self, timeshare: list, window: int = 5) -> list:
    """
    è¯†åˆ«å³°å€¼ç‚¹
    
    ç®—æ³•åŸç†ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ»‘åŠ¨çª—å£å³°å€¼è¯†åˆ«                     â”‚
    â”‚                                       â”‚
    â”‚  ä»·æ ¼                                 â”‚
    â”‚   ^                                   â”‚
    â”‚   â”‚       â•±â•²                         â”‚
    â”‚   â”‚      â•±  â•²    â† å³°å€¼              â”‚
    â”‚   â”‚     â•±    â•²                       â”‚
    â”‚   â”‚  â•±â”€â•¯      â•²â”€â•®                   â”‚
    â”‚   â”‚ â•±            â•²                   â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´      â”‚
    â”‚      â””â”€5åˆ†é’Ÿçª—å£â”€â”˜                   â”‚
    â”‚                                       â”‚
    â”‚  åˆ¤å®šæ¡ä»¶ï¼š                           â”‚
    â”‚  åœ¨å‰å5åˆ†é’Ÿå†…ï¼Œè¯¥ç‚¹ä»·æ ¼æœ€é«˜          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    peaks = []
    
    for i in range(window, len(timeshare) - window):
        current_price = timeshare[i]['price']
        is_peak = True
        
        # æ£€æŸ¥å‰åçª—å£èŒƒå›´
        for j in range(i - window, i + window + 1):
            if j == i:
                continue
            
            if timeshare[j]['price'] > current_price:
                is_peak = False
                break
        
        # å¦‚æœæ˜¯å³°å€¼ï¼Œè®°å½•
        if is_peak:
            peaks.append({
                'price': current_price,
                'time': timeshare[i]['time'],
                'timestamp': timeshare[i]['timestamp'],
                'volume': timeshare[i]['volume'],
                'index': i
            })
    
    return peaks
```

**ç¤ºä¾‹**ï¼š
```
åˆ†æ—¶æ•°æ®ï¼š
09:30  15.20
09:31  15.35
09:32  15.50  â† å³°å€¼1ï¼ˆå‰å5åˆ†é’Ÿæœ€é«˜ï¼‰
09:33  15.42
09:34  15.38
...
10:15  15.85  â† å³°å€¼2ï¼ˆå‰å5åˆ†é’Ÿæœ€é«˜ï¼‰
10:16  15.80
...

è¯†åˆ«ç»“æœï¼š
Peak 1: 15.50 @ 09:32
Peak 2: 15.85 @ 10:15
Peak 3: 16.02 @ 11:20
...
```

#### ç®—æ³•2ï¼šå¯¼æ•°æ³•ï¼ˆé«˜çº§ï¼‰

```python
def _find_peaks_by_derivative(self, timeshare: list) -> list:
    """
    ä½¿ç”¨å¯¼æ•°æ³•è¯†åˆ«å³°å€¼
    
    åŸç†ï¼š
    1. è®¡ç®—ä»·æ ¼å˜åŒ–ç‡ï¼ˆä¸€é˜¶å¯¼æ•°ï¼‰
    2. æ‰¾åˆ°å¯¼æ•°ä»æ­£å˜è´Ÿçš„ç‚¹ï¼ˆå³°å€¼ï¼‰
    
    æ•°å­¦è¡¨è¾¾ï¼š
    f'(t) > 0  â†’  f'(t) = 0  â†’  f'(t) < 0
    ï¼ˆä¸Šå‡ï¼‰      ï¼ˆå³°é¡¶ï¼‰      ï¼ˆä¸‹é™ï¼‰
    """
    peaks = []
    
    # è®¡ç®—ä¸€é˜¶å·®åˆ†ï¼ˆè¿‘ä¼¼å¯¼æ•°ï¼‰
    derivatives = []
    for i in range(1, len(timeshare)):
        price_change = timeshare[i]['price'] - timeshare[i-1]['price']
        time_diff = (timeshare[i]['timestamp'] - timeshare[i-1]['timestamp']).total_seconds()
        derivative = price_change / time_diff if time_diff > 0 else 0
        derivatives.append(derivative)
    
    # æ‰¾åˆ°å¯¼æ•°ä»æ­£å˜è´Ÿçš„ç‚¹
    for i in range(1, len(derivatives)):
        if derivatives[i-1] > 0 and derivatives[i] < 0:
            # å³°å€¼åœ¨ i ä½ç½®
            peak_idx = i + 1  # +1å› ä¸ºderivativesæ¯”timeshareå°‘1ä¸ªå…ƒç´ 
            peaks.append({
                'price': timeshare[peak_idx]['price'],
                'time': timeshare[peak_idx]['time'],
                'timestamp': timeshare[peak_idx]['timestamp'],
                'volume': timeshare[peak_idx]['volume'],
                'index': peak_idx,
                'derivative_before': derivatives[i-1],
                'derivative_after': derivatives[i]
            })
    
    return peaks
```

---

### 3.3 çªç ´åˆ¤å®š

```python
async def detect(self, stock_code: str) -> dict:
    """
    æ£€æµ‹ç ´å³°çªç ´
    
    æµç¨‹ï¼š
    1. è·å–ä»Šæ—¥åˆ†æ—¶æ•°æ®
    2. è¯†åˆ«æ‰€æœ‰å³°å€¼
    3. æ‰¾åˆ°æœ€é«˜å³°
    4. åˆ¤æ–­å½“å‰æ˜¯å¦çªç ´
    5. è¿‡æ»¤å‡çªç ´
    """
    # 1. è·å–æ•°æ®
    timeshare = await self.data_source.get_today_timeshare(stock_code)
    
    if len(timeshare) < 10:
        return {'detected': False, 'reason': 'æ•°æ®ä¸è¶³'}
    
    # 2. è¯†åˆ«å³°å€¼
    peaks = self._find_peaks(timeshare, window=5)
    
    if not peaks:
        return {'detected': False, 'reason': 'æ— å³°å€¼'}
    
    # 3. æ‰¾åˆ°æœ€é«˜å³°
    max_peak = max(peaks, key=lambda p: p['price'])
    
    # 4. å½“å‰ä»·æ ¼
    current = timeshare[-1]
    
    # 5. åˆ¤æ–­çªç ´ï¼ˆå¿…é¡» > å³°å€¼ï¼Œä¸èƒ½ç­‰äºï¼‰
    if current['price'] > max_peak['price']:
        # 6. è¿‡æ»¤å‡çªç ´
        if not self._is_valid_breakout(max_peak, current, timeshare):
            return {
                'detected': False,
                'reason': 'å‡çªç ´',
                'peak_price': max_peak['price'],
                'current_price': current['price']
            }
        
        # 7. è®¡ç®—çªç ´å¹…åº¦
        breakout_pct = (current['price'] - max_peak['price']) / max_peak['price'] * 100
        
        return {
            'detected': True,
            'peak_price': max_peak['price'],
            'peak_time': max_peak['time'],
            'peak_index': max_peak['index'],
            'current_price': current['price'],
            'breakout_percent': breakout_pct,
            'peak_volume': max_peak['volume'],
            'time_since_peak': (current['timestamp'] - max_peak['timestamp']).total_seconds() / 60  # åˆ†é’Ÿ
        }
    
    # 8. æœªçªç ´ï¼Œè¿”å›è·ç¦»
    return {
        'detected': False,
        'reason': 'æœªçªç ´',
        'peak_price': max_peak['price'],
        'current_price': current['price'],
        'distance_to_peak': (max_peak['price'] - current['price']) / current['price'] * 100
    }
```

---

### 3.4 å‡çªç ´è¿‡æ»¤

```python
def _is_valid_breakout(self, peak: dict, current: dict, timeshare: list) -> bool:
    """
    è¿‡æ»¤å‡çªç ´
    
    å‡çªç ´ç‰¹å¾ï¼š
    1. çªç ´å¹…åº¦å¤ªå°ï¼ˆ< 0.5%ï¼‰
    2. æˆäº¤é‡æ²¡æœ‰æ”¾å¤§
    3. çªç ´åç«‹å³å›è½
    4. å³°å€¼æ—¶é—´å¤ªè¿‘ï¼ˆ< 5åˆ†é’Ÿï¼‰
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  çœŸçªç ´ vs å‡çªç ´                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                       â”‚
    â”‚  çœŸçªç ´ï¼š                             â”‚
    â”‚  å³°å€¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ çªç ´ï¼ˆæ”¾é‡ï¼‰        â”‚
    â”‚  15.50         15.85 (+2.3%)         â”‚
    â”‚                é‡æ¯” 2.5x              â”‚
    â”‚                                       â”‚
    â”‚  å‡çªç ´ï¼š                             â”‚
    â”‚  å³°å€¼ â”€â†’ çªç ´ï¼ˆæ— é‡ï¼‰â”€â†’ å›è½         â”‚
    â”‚  15.50   15.52 (+0.1%)  15.48        â”‚
    â”‚          é‡æ¯” 0.8x                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    
    # æ¡ä»¶1ï¼šçªç ´å¹…åº¦å¿…é¡» > 0.5%
    breakout_pct = (current['price'] - peak['price']) / peak['price'] * 100
    if breakout_pct < 0.5:
        logger.debug(f"çªç ´å¹…åº¦å¤ªå°: {breakout_pct:.2f}%")
        return False
    
    # æ¡ä»¶2ï¼šæˆäº¤é‡å¿…é¡»æ”¾å¤§ï¼ˆè‡³å°‘1.5å€ï¼‰
    # è®¡ç®—å³°å€¼å‰åçš„å¹³å‡æˆäº¤é‡
    peak_idx = peak['index']
    avg_volume_before_peak = sum(
        item['volume'] for item in timeshare[max(0, peak_idx-5):peak_idx]
    ) / min(5, peak_idx)
    
    volume_ratio = current['volume'] / avg_volume_before_peak if avg_volume_before_peak > 0 else 0
    if volume_ratio < 1.5:
        logger.debug(f"æˆäº¤é‡æœªæ”¾å¤§: {volume_ratio:.2f}x")
        return False
    
    # æ¡ä»¶3ï¼šçªç ´åä¸èƒ½ç«‹å³å›è½
    # æ£€æŸ¥æœ€è¿‘3åˆ†é’Ÿçš„ä»·æ ¼èµ°åŠ¿
    recent_prices = [item['price'] for item in timeshare[-3:]]
    if len(recent_prices) >= 2:
        # å¦‚æœæœ€è¿‘ä»·æ ¼æŒç»­ä¸‹è·Œï¼Œå¯èƒ½æ˜¯å‡çªç ´
        is_falling = all(
            recent_prices[i] > recent_prices[i+1] 
            for i in range(len(recent_prices)-1)
        )
        if is_falling:
            logger.debug("çªç ´åæŒç»­å›è½")
            return False
    
    # æ¡ä»¶4ï¼šå³°å€¼æ—¶é—´ä¸èƒ½å¤ªè¿‘ï¼ˆé¿å…éœ‡è¡ï¼‰
    time_since_peak = (current['timestamp'] - peak['timestamp']).total_seconds() / 60
    if time_since_peak < 5:
        logger.debug(f"å³°å€¼æ—¶é—´å¤ªè¿‘: {time_since_peak:.1f}åˆ†é’Ÿ")
        return False
    
    return True
```

---

### 3.5 å®æˆ˜æ¡ˆä¾‹

**æ¡ˆä¾‹ï¼šé“¶æ²³ç£ä½“ï¼ˆ300127ï¼‰ç ´å³°çªç ´**

```
åˆ†æ—¶èµ°åŠ¿ï¼š
09:30 â”€â”€â”€â”€â”€â”€ å¼€ç›˜ 38.20
10:15 â”€â”
10:20 â”€â”¤ ç¬¬ä¸€æ³¢æ‹‰å‡
10:25 â”€â”˜ å³°å€¼1: 38.50
10:30 â”€â”€â”€â”€â”€â”€ å›è°ƒ 38.10
11:00 â”€â”
11:05 â”€â”¤ ç¬¬äºŒæ³¢æ‹‰å‡
11:10 â”€â”˜ å³°å€¼2: 38.74ï¼ˆä»Šæ—¥æœ€é«˜ï¼‰
11:15 â”€â”€â”€â”€â”€â”€ å›è°ƒ 38.45
13:30 â”€â”€â”€â”€â”€â”€ æ¨ªç›˜ 38.50
14:00 â”€â”€â”€â”€â”€â”€ çªç ´å¼€å§‹ï¼

æ£€æµ‹ç»“æœï¼š
â”œâ”€ æœ€é«˜å³°: 38.74 @ 11:10
â”œâ”€ å½“å‰ä»·: 38.85 @ 14:02
â”œâ”€ çªç ´å¹…åº¦: +0.28%
â”œâ”€ æˆäº¤é‡: 1.8å€æ”¾å¤§
â”œâ”€ è·ç¦»å³°å€¼: 172åˆ†é’Ÿ
â””â”€ åˆ¤å®š: çœŸçªç ´ âœ“

è§¦å‘æŠ¥è­¦ï¼šã€ç ´å³°çªç ´ã€‘300127 é“¶æ²³ç£ä½“
           çªç ´ä»·ä½ 38.85ï¼Œå‰é«˜ 38.74
```

---

## ğŸ“Š åŠŸèƒ½å››ï¼šè¿ç»­å¼‚åŠ¨ç»Ÿè®¡ï¼ˆæ€»ç»“ï¼‰

è¿™ä¸ªåŠŸèƒ½å·²ç»åœ¨çŠ¶æ€æœºä¸­è¯¦ç»†è®²è§£äº†ï¼Œè¿™é‡Œåšä¸ªæ€»ç»“ï¼š

### 4.1 ä¸‰ä¸ªå…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| **è¿ç»­æ‹‰** | æœ€è¿‘è¿ç»­å‡ æ¬¡å¼‚åŠ¨ | è¡¡é‡å½“å‰çˆ†å‘åŠ› |
| **åæ‹‰å‡ ** | æœ€è¿‘10æ¬¡ä¸­å‡ æ¬¡å¼‚åŠ¨ | è¡¡é‡æ•´ä½“å¼ºåŠ¿åº¦ |
| **æ€»æ¬¡æ•°** | ä»Šæ—¥æ€»å¼‚åŠ¨æ¬¡æ•° | è¡¡é‡æ´»è·ƒåº¦ |

### 4.2 è¯„åˆ†ä½“ç³»

```python
def calculate_anomaly_strength_score(continuous: int, last_10: int, total: int) -> int:
    """
    è®¡ç®—å¼‚åŠ¨å¼ºåº¦è¯„åˆ†
    
    è¯„åˆ†è§„åˆ™ï¼š
    â”œâ”€ è¿ç»­æ‹‰ï¼ˆ40åˆ†ï¼‰ï¼šè¿ç»­æ¬¡æ•°è¶Šå¤šï¼Œå½“å‰è¶Šå¼º
    â”‚  1æ¬¡ = 10åˆ†
    â”‚  3æ¬¡ = 20åˆ†
    â”‚  5æ¬¡ = 30åˆ†
    â”‚  7æ¬¡+ = 40åˆ†ï¼ˆæ»¡åˆ†ï¼‰
    â”‚
    â”œâ”€ åæ‹‰å‡ ï¼ˆ40åˆ†ï¼‰ï¼šæ¯”ä¾‹è¶Šé«˜ï¼Œæ•´ä½“è¶Šå¼º
    â”‚  5/10 = 20åˆ†
    â”‚  7/10 = 28åˆ†
    â”‚  9/10 = 36åˆ†
    â”‚  10/10 = 40åˆ†ï¼ˆæ»¡åˆ†ï¼‰
    â”‚
    â””â”€ æ€»æ¬¡æ•°ï¼ˆ20åˆ†ï¼‰ï¼šæ¬¡æ•°è¶Šå¤šï¼Œè¶Šæ´»è·ƒ
       5æ¬¡ = 5åˆ†
       10æ¬¡ = 10åˆ†
       15æ¬¡ = 15åˆ†
       20æ¬¡+ = 20åˆ†ï¼ˆæ»¡åˆ†ï¼‰
    """
    # è¿ç»­æ‹‰è¯„åˆ†
    continuous_score = min(continuous / 7 * 40, 40)
    
    # åæ‹‰å‡ è¯„åˆ†
    last_10_score = (last_10 / 10) * 40 if last_10 <= 10 else 40
    
    # æ€»æ¬¡æ•°è¯„åˆ†
    total_score = min(total / 20 * 20, 20)
    
    return int(continuous_score + last_10_score + total_score)
```

---

## ğŸ”— åŠŸèƒ½é›†æˆæ–¹æ¡ˆ

### å‰ç«¯å±•ç¤ºæ•´åˆ

```typescript
// åœ¨æœºä¼šæµå¡ç‰‡ä¸­å±•ç¤ºæ‰€æœ‰æŒ‡æ ‡
<div className="opportunity-card">
  {/* åŸºç¡€ä¿¡æ¯ */}
  <div className="stock-header">
    <span className="symbol">{stock.code}</span>
    <span className="name">{stock.name}</span>
    
    {/* çŠ¶æ€æœº */}
    <AnomalyStateIndicator 
      state={stock.state}
      color={getStateColor(stock.state)}
    />
  </div>
  
  {/* æ ¸å¿ƒæŒ‡æ ‡ */}
  <div className="metrics-row">
    <span className="metric change">{stock.changePercent}%</span>
    <span className="divider">|</span>
    <span className="metric">è¿ç»­ {stock.continuousCount}</span>
    <span className="divider">|</span>
    <span className="metric">10ä¸­{stock.last10Count}</span>
    <span className="divider">|</span>
    <span className="metric">æ€»{stock.totalCount}æ¬¡</span>
  </div>
  
  {/* ç‰¹æ®Šæ ‡ç­¾ */}
  <div className="tags-row">
    {stock.hasConsolidationBreakout && (
      <span className="tag special">
        ğŸ“Š æ¨ªç›˜çªç ´ å¼ºåº¦{stock.consolidationStrength}
      </span>
    )}
    
    {stock.hasPeakBreakout && (
      <span className="tag special">
        ğŸ”ï¸ ç ´å³°çªç ´ +{stock.breakoutPercent}%
      </span>
    )}
  </div>
</div>
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ç­–ç•¥

```python
from functools import lru_cache
from datetime import datetime, timedelta

class CachedDetector:
    def __init__(self):
        self.cache = {}
        self.cache_ttl = 60  # 60ç§’ç¼“å­˜
    
    async def detect_with_cache(self, stock_code: str, detector_func):
        """å¸¦ç¼“å­˜çš„æ£€æµ‹"""
        cache_key = f"{stock_code}_{detector_func.__name__}"
        
        # æ£€æŸ¥ç¼“å­˜
        if cache_key in self.cache:
            cached_data, cached_time = self.cache[cache_key]
            if (datetime.now() - cached_time).seconds < self.cache_ttl:
                return cached_data
        
        # æ‰§è¡Œæ£€æµ‹
        result = await detector_func(stock_code)
        
        # æ›´æ–°ç¼“å­˜
        self.cache[cache_key] = (result, datetime.now())
        
        return result
```

### 2. å¹¶å‘æ£€æµ‹

```python
import asyncio

async def scan_all_stocks_parallel(stock_codes: list):
    """å¹¶å‘æ£€æµ‹æ‰€æœ‰è‚¡ç¥¨"""
    detectors = [
        ConsolidationBreakoutDetector(),
        PeakBreakoutDetector(),
        AnomalyStateMachine()
    ]
    
    async def detect_one_stock(code):
        results = {}
        tasks = [detector.detect(code) for detector in detectors]
        results_list = await asyncio.gather(*tasks, return_exceptions=True)
        
        return {
            'code': code,
            'consolidation': results_list[0],
            'peak': results_list[1],
            'state': results_list[2]
        }
    
    # å¹¶å‘å¤„ç†æ‰€æœ‰è‚¡ç¥¨
    tasks = [detect_one_stock(code) for code in stock_codes]
    return await asyncio.gather(*tasks)
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒç®—æ³•å¯¹æ¯”

| åŠŸèƒ½ | ç®—æ³•å¤æ‚åº¦ | å‡†ç¡®ç‡ | å®æ—¶æ€§ |
|------|-----------|--------|--------|
| æ¨ªç›˜çªç ´ | O(n) | 85%+ | 5-10ç§’ |
| çŠ¶æ€æœº | O(1) | 95%+ | å®æ—¶ |
| ç ´å³°çªç ´ | O(n) | 80%+ | 5ç§’ |
| è¿ç»­å¼‚åŠ¨ | O(n) | 100% | å®æ—¶ |

### å®æ–½ä¼˜å…ˆçº§

1. **Day 1-2**: çŠ¶æ€æœºï¼ˆæœ€åŸºç¡€ï¼‰
2. **Day 3**: è¿ç»­å¼‚åŠ¨ç»Ÿè®¡ï¼ˆä¾èµ–çŠ¶æ€æœºï¼‰
3. **Day 4**: æ¨ªç›˜çªç ´æ£€æµ‹ï¼ˆç‹¬ç«‹ï¼‰
4. **Day 5**: ç ´å³°çªç ´æ£€æµ‹ï¼ˆç‹¬ç«‹ï¼‰

### æµ‹è¯•ç”¨ä¾‹

```python
# tests/test_all_features.py

async def test_complete_workflow():
    """æµ‹è¯•å®Œæ•´å·¥ä½œæµ"""
    stock_code = "300123"
    
    # 1. æ£€æµ‹æ¨ªç›˜çªç ´
    cb_detector = ConsolidationBreakoutDetector()
    cb_result = await cb_detector.detect(stock_code)
    assert cb_result['detected'] == True
    assert cb_result['strength'] >= 60
    
    # 2. æ›´æ–°çŠ¶æ€æœº
    state_machine = AnomalyStateMachine()
    state_result = state_machine.update(stock_code, {
        'price': 15.85,
        'change_percent': 5.2,
        'volume': 500000,
        'is_anomaly': True,
        'timestamp': datetime.now()
    })
    assert state_result['state'] == 'å¼€å§‹æ‹‰å‡'
    assert state_result['should_alert'] == True
    
    # 3. æ£€æµ‹ç ´å³°çªç ´
    pb_detector = PeakBreakoutDetector()
    pb_result = await pb_detector.detect(stock_code)
    assert pb_result['detected'] == True
    
    # 4. éªŒè¯è¿ç»­å¼‚åŠ¨ç»Ÿè®¡
    assert state_result['continuous_count'] >= 1
    assert state_result['last_10_count'] >= 1
```

---

**å‡†å¤‡å¥½å¼€å§‹å®æ–½äº†å—ï¼Ÿéœ€è¦æˆ‘å…ˆå®ç°å“ªä¸ªåŠŸèƒ½ï¼Ÿ**
