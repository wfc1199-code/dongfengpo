# 二板候选分时图问题诊断
> 日期: 2025-11-24 21:45

## 问题描述

用户反馈："二板候选里面的数据分时图也不对"

## 可能的问题

### 1. Y轴范围问题（最可能）
如果二板候选中的股票也是主板股票（000/002/600开头），可能遇到和之前一样的问题：
- Y轴不对称
- 0轴不在中间
- 支撑压力线位置不对

**已修复**：
- ✅ `TimeShareChartFixed.tsx` 已修复Y轴计算
- ✅ 股票代码识别逻辑已优化
- ✅ 对称性验证已添加

### 2. 股票代码传递问题
如果点击二板候选中的股票，传递到分时图组件的代码格式不对：
- 可能带了额外的前缀或后缀
- 可能是空值或undefined

### 3. 缓存问题
前端可能使用了旧的代码版本：
- 浏览器缓存
- 开发服务器没有重新编译
- Service Worker缓存

### 4. API数据问题
二板候选的数据来源可能有问题：
- 昨收价不准确
- 股票名称/代码不匹配
- 返回的数据格式不对

## 数据流向分析

```
TomorrowSecondBoardCandidates
  └─> 点击股票
    └─> onStockSelect(stockCode)
      └─> withStockSelect
        └─> App/ManagementDashboard
          └─> setSelectedStock(stockCode)
            └─> TimeShareChartFixed
              └─> stockCode prop
                └─> fetchTimeshare(stockCode)
                  └─> API: /api/stocks/{stockCode}/timeshare
```

## 诊断步骤

### 步骤1: 检查前端是否使用了最新代码

**操作**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 点击二板候选中的任意股票
4. 查看是否有类似的日志：
   ```
   🔍 股票代码分析: 原始=002864, 纯代码=002864
   📊 Y轴范围计算: 股票=002864(主板), 昨收=32.50, 涨跌幅限制=10%
      Y轴范围=[29.25, 35.75], 上=3.25, 下=3.25, 对称=✓
   ```

**如果没有看到这些日志**：
- 说明前端没有使用最新代码
- 需要强制刷新：Cmd+Shift+R（Mac）或 Ctrl+Shift+R（Windows）

### 步骤2: 检查传递的股票代码

**操作**：
1. 在Console中输入并执行：
   ```javascript
   window.addEventListener('click', (e) => {
     const target = e.target;
     if (target.classList.contains('candidate-info') || 
         target.closest('.candidate-info')) {
       console.log('点击的股票:', target.textContent);
     }
   });
   ```
2. 点击二板候选中的股票
3. 查看输出的股票代码是否正确

### 步骤3: 检查API返回的数据

**操作**：
1. 在浏览器开发者工具中切换到 Network 标签
2. 点击二板候选中的一只股票（例如：002864）
3. 查找 `timeshare` 或 `002864` 的请求
4. 查看返回的数据：
   - `yesterday_close` 是否正确？
   - `minute_data` 是否有数据？
   - 价格范围是否合理？

### 步骤4: 直接测试分时图组件

**操作**：
1. 打开浏览器控制台
2. 查找分时图的iframe或div
3. 检查其 props：
   ```javascript
   // 在React DevTools中
   // 找到 TimeShareChartFixed 组件
   // 查看 props.stockCode 的值
   ```

## 常见问题排查

### Q1: 二板候选中都是什么类型的股票？
**检查方法**：
```bash
# 后端测试
curl "http://localhost:9000/api/limit-up/second-board-candidates" | jq '.data.candidates[] | {code, name}'
```

**预期**：
- 大部分应该是主板股票（000/002/600开头）
- 少数可能是科创板（688）或创业板（300）

### Q2: 分时图显示什么错误？
可能的错误类型：
- **Y轴不对称** → Y轴计算问题（已修复）
- **数据不显示** → API问题或网络问题
- **显示错误的股票** → 股票代码传递问题
- **加载中不消失** → API超时或缓存问题

### Q3: 如何确认是不是缓存问题？
**操作**：
1. 打开新的无痕窗口（Cmd+Shift+N 或 Ctrl+Shift+N）
2. 访问 http://localhost:3000
3. 测试二板候选的分时图
4. 如果无痕窗口正常，普通窗口不正常 → 就是缓存问题

## 已知修复

### 修复1: Y轴对称性（已完成）
- 文件：`frontend/src/components/TimeShareChartFixed.tsx`
- 修改：使用 `priceRange` 方式计算，确保上下对称
- 状态：✅ 已部署

### 修复2: 股票代码识别（已完成）
- 文件：`frontend/src/components/TimeShareChartFixed.tsx`
- 修改：移除市场前缀后判断板块类型
- 状态：✅ 已部署

### 修复3: 自选股搜索（已完成）
- 文件：`frontend/src/services/backend.service.ts`
- 修改：参数从 `q=` 改为 `keyword=`
- 状态：✅ 已部署

### 修复4: 缓存优化（已完成）
- 文件：`backend/modules/stocks/service.py`
- 修改：添加30秒本地文件缓存
- 状态：✅ 已部署
- 效果：首次9秒，后续0.02秒

## 临时解决方案

如果分时图仍然有问题，可以：

### 方案A: 强制刷新（最简单）
1. 按住 Shift 键
2. 点击浏览器刷新按钮
3. 或按 Cmd+Shift+R（Mac）/ Ctrl+Shift+R（Windows）

### 方案B: 清除浏览器缓存
1. 打开开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

### 方案C: 重启开发服务器
```bash
# 停止前端
pkill -f "react-scripts"

# 重新启动
cd /Users/wangfangchun/东风破/frontend
npm start
```

## 下一步行动

请告诉我：

1. **具体现象**：
   - 0轴在什么位置？（偏上/偏下/正中）
   - 左侧刻度显示什么？（-10%到+10%？还是其他？）
   - 支撑压力线在哪里？（超出图表？位置不对？）

2. **控制台输出**：
   - 打开F12，切换到Console
   - 点击二板候选的股票
   - 把控制台输出的日志发给我

3. **测试股票**：
   - 具体是哪只股票有问题？
   - 股票代码是什么？
   - 昨收价是多少？

4. **浏览器和刷新**：
   - 是否已经强制刷新过（Cmd+Shift+R）？
   - 使用的是什么浏览器？
   - 是否尝试过无痕模式？

---

**根据您提供的具体信息，我可以精确定位并修复问题！**
