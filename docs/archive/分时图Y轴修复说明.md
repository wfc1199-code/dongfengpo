# 分时图Y轴范围修复说明
> 日期: 2025-11-24 21:00
> 问题: 10%和20%涨停板股票Y轴显示不正确

## 问题根源

### 原始代码问题
```typescript
// ❌ 错误的判断方式
if (stockCode.startsWith('688') || stockCode.startsWith('sz688') || stockCode.startsWith('sh688')) {
  limitPercent = 0.2; // 科创板
}
```

**问题**：
1. 股票代码可能带前缀（sh688291）或不带前缀（688291）
2. 判断逻辑不统一，会导致识别错误
3. 没有覆盖所有市场类型

### 实际情况
- 后端返回的股票代码：`002864`（不带前缀）
- 前端代码判断：`stockCode.startsWith('688')` → **失败**
- 导致科创板被当成主板处理

## 修复方案

### 1. 统一代码格式
```typescript
// ✅ 移除市场前缀，统一判断
const pureCode = stockCode.replace(/^(sh|sz|hk)/, '');
```

### 2. 完善判断逻辑
```typescript
if (pureCode.startsWith('688')) {
  limitPercent = 0.2;  // 科创板
  boardType = '科创板';
} else if (pureCode.startsWith('689')) {
  limitPercent = 0.2;  // 科创板（689也是科创板）
  boardType = '科创板';
} else if (pureCode.startsWith('300')) {
  limitPercent = 0.2;  // 创业板
  boardType = '创业板';
} else if (pureCode.startsWith('8')) {
  limitPercent = 0.3;  // 北交所
  boardType = '北交所';
} else if (stockCode.startsWith('hk')) {
  limitPercent = 1.0;  // 港股无涨跌停
  boardType = '港股';
} else {
  limitPercent = 0.1;  // 主板
  boardType = '主板';
}
```

### 3. 添加调试日志
```typescript
debugLog(`🔍 股票代码分析: 原始=${stockCode}, 纯代码=${pureCode}`);
debugLog(`📊 Y轴范围: ${boardType}, 昨收=${yesterdayClose}, 涨跌幅=${limitPercent*100}%`);
```

## 中国股市涨跌停板规则

### 主板（10%）
- **上交所**：600/601/603/605开头
- **深交所**：000/001/002/003开头
- 涨停价 = 昨收价 × 1.1
- 跌停价 = 昨收价 × 0.9

### 科创板（20%）
- **688开头**：科创板主板
- **689开头**：科创板存托凭证
- 涨停价 = 昨收价 × 1.2
- 跌停价 = 昨收价 × 0.8

### 创业板（20%）
- **300/301开头**
- 涨停价 = 昨收价 × 1.2
- 跌停价 = 昨收价 × 0.8

### 北交所（30%）
- **8开头**
- 涨停价 = 昨收价 × 1.3
- 跌停价 = 昨收价 × 0.7

### 港股（无限制）
- **hk开头**
- 无涨跌停限制

## 测试用例

### 测试1：主板股票 002864
```
股票：盘龙药业 (002864)
板块：主板
昨收：32.50
涨跌幅限制：10%

计算：
- Y轴最大值 = 32.50 × 1.1 = 35.75
- Y轴最小值 = 32.50 × 0.9 = 29.25
- 0轴（昨收）= 32.50（应在Y轴中间）
```

### 测试2：科创板股票 688291
```
股票：金橙子 (688291)
板块：科创板
昨收：29.03
涨跌幅限制：20%

计算：
- Y轴最大值 = 29.03 × 1.2 = 34.84
- Y轴最小值 = 29.03 × 0.8 = 23.22
- 0轴（昨收）= 29.03（应在Y轴中间）
```

### 测试3：创业板股票 300750
```
股票：宁德时代 (300750)
板块：创业板
昨收：150.00
涨跌幅限制：20%

计算：
- Y轴最大值 = 150.00 × 1.2 = 180.00
- Y轴最小值 = 150.00 × 0.8 = 120.00
- 0轴（昨收）= 150.00（应在Y轴中间）
```

## 验证方法

### 1. 浏览器控制台查看日志
打开浏览器开发者工具（F12），在Console中应该看到：
```
🔍 股票代码分析: 原始=002864, 纯代码=002864
📊 Y轴范围计算: 股票=002864(主板), 昨收=32.50, 涨跌幅限制=10%, Y轴=[29.25, 35.75]
```

### 2. 检查0轴位置
- 0轴（昨收价黄色虚线）应该在图表垂直方向的正中间
- 向上空间和向下空间应该相等
- 左侧Y轴显示：-10% 到 +10%（主板）或 -20% 到 +20%（科创板/创业板）

### 3. 检查支撑压力线
- 所有支撑压力线价格应该在Y轴min/max范围内
- 超出范围的线条会被自动过滤掉
- 控制台会显示过滤的数量

## 常见问题

### Q1: 为什么有些股票Y轴显示还是不对？
**A**: 可能是昨收价数据有问题，检查API返回的 `yesterday_close` 字段。

### Q2: 0轴不在中间怎么办？
**A**: 检查是否使用了 `initialYesterdayClose`，这个值应该在切换股票时重置。

### Q3: 支撑压力线显示位置不对？
**A**: 支撑压力线如果超出Y轴范围会被过滤，这是正常的。如果价格在范围内但位置不对，可能是支撑压力计算本身的问题。

### Q4: 北交所股票Y轴怎么还是不对？
**A**: 确认股票代码是否为8开头，如果是，应该使用30%涨跌幅限制。

## 后续优化建议

### 1. 股票代码标准化
在数据获取层统一处理股票代码格式：
```typescript
function normalizeStockCode(code: string): string {
  // 统一移除市场前缀
  return code.replace(/^(sh|sz|hk)/, '');
}
```

### 2. 板块信息从后端获取
```typescript
interface StockInfo {
  code: string;
  name: string;
  board: 'main' | 'sci-tech' | 'gem' | 'bse' | 'hk';
  limitPercent: number;  // 直接返回涨跌幅限制
}
```

### 3. 动态涨跌停限制
某些特殊情况（ST股票、新股上市首日）涨跌幅限制不同，应该从后端获取实际限制。

## 修改文件清单

- ✅ `frontend/src/components/TimeShareChartFixed.tsx`
  - 修改涨跌停板判断逻辑
  - 添加股票代码格式统一处理
  - 增强调试日志输出
  - 过滤超出范围的支撑压力线

## 测试步骤

1. **强制刷新浏览器**：Cmd+Shift+R（Mac）或 Ctrl+Shift+R（Windows）
2. **打开开发者工具**：F12，切换到Console标签
3. **切换不同类型股票**：
   - 主板：002864（盘龙药业）
   - 科创板：688291（金橙子）
   - 创业板：300750（宁德时代）
4. **查看控制台日志**：确认识别的板块类型正确
5. **检查Y轴范围**：确认0轴在中间位置

## 预期效果

- ✅ 主板股票（002864）：Y轴显示 -10% 到 +10%
- ✅ 科创板股票（688291）：Y轴显示 -20% 到 +20%
- ✅ 创业板股票（300开头）：Y轴显示 -20% 到 +20%
- ✅ 0轴（昨收价黄线）在图表正中间
- ✅ 支撑压力线在合理位置显示

---

**请立即刷新浏览器测试，并查看控制台日志确认修复效果！**
