# 自选股搜索功能修复
> 日期: 2025-11-24 21:30
> 问题: 添加自选股时，"思看科技"搜索不到

## 问题根源

### API参数不匹配

**前端代码**（错误）：
```typescript
searchStocks: (query: string, limit = 8) => 
  fetch(`/api/stocks/search?q=${encodeURIComponent(query)}&limit=${limit}`)
```

**后端代码**（正确）：
```python
@router.get("/search")
async def search_stocks(keyword: str, limit: int = 20):
    ...
```

**问题**：
- 前端使用参数名 `q`
- 后端期望参数名 `keyword`
- 导致后端收不到搜索关键词，返回空结果

## 验证过程

### 1. 确认股票存在
```bash
# 使用akshare验证
import akshare as ak
df = ak.stock_info_a_code_name()
result = df[df['name'].str.contains('思看', na=False)]
# 结果：688583 思看科技 ✓
```

### 2. 测试后端API
```bash
# 直接测试后端（正确参数名）
curl "http://localhost:9000/api/stocks/search?keyword=思看"
# 结果：{"stocks": [{"code": "688583", "name": "思看科技"}]} ✓

# 使用错误的参数名
curl "http://localhost:9000/api/stocks/search?q=思看"
# 结果：400 Bad Error (缺少必需参数 keyword) ✗
```

### 3. 后端搜索引擎测试
```python
# 测试后端搜索功能
result1 = await service.search_stocks('688583', 10)  # 按代码 ✓
result2 = await service.search_stocks('思看', 10)    # 按名称 ✓
result3 = await service.search_stocks('SK', 10)      # 按拼音 ✓
```

## 修复方案

### 修改文件
`frontend/src/services/backend.service.ts`

### 修改内容
```typescript
// 修改前：
searchStocks: (query: string, limit = 8) => 
  fetch(withLegacy(`/api/stocks/search?q=${encodeURIComponent(query)}&limit=${limit}`))

// 修改后：
searchStocks: (query: string, limit = 8) => 
  fetch(withLegacy(`/api/stocks/search?keyword=${encodeURIComponent(query)}&limit=${limit}`))
```

## 搜索功能支持

后端全市场搜索引擎支持多种搜索方式：

### 1. 按股票代码搜索
```
输入: 688583
结果: 思看科技 (688583)
```

### 2. 按股票名称搜索
```
输入: 思看
结果: 思看科技 (688583)

输入: 思看科技
结果: 思看科技 (688583)
```

### 3. 按拼音首字母搜索
```
输入: SKKJ
结果: 思看科技 (688583)

输入: SK
结果: 多个匹配（包括思看科技）
```

### 4. 模糊搜索
```
输入: 科技
结果: 所有名称包含"科技"的股票
```

## 搜索数据源

后端使用多数据源保证搜索准确性：

1. **东方财富API** - 主要数据源
2. **腾讯财经API** - 备用数据源
3. **新浪财经API** - 降级数据源
4. **AkShare** - 离线数据源

## 测试步骤

### 1. 刷新浏览器
强制刷新：Cmd+Shift+R（Mac）或 Ctrl+Shift+R（Windows）

### 2. 测试搜索
在添加自选股的输入框中输入：
- `思看` → 应该显示 "思看科技 (688583)"
- `688583` → 应该显示 "思看科技 (688583)"
- `SKKJ` → 应该显示 "思看科技 (688583)"

### 3. 验证添加
- 点击搜索结果
- 确认股票被添加到自选股列表
- 查看分时图是否正常显示

## 其他已知股票

后端预定义列表中包含100+常见股票，如果搜索不到某只股票：

1. **先尝试输入股票代码** - 6位数字
2. **如果代码也搜不到** - 说明是罕见股票，后端会自动从API获取
3. **拼音搜索不到** - 尝试输入完整的中文名称

## 常见问题

### Q: 为什么有些股票搜不到？
A: 
1. 检查股票代码是否正确（6位数字）
2. 确认股票是否已退市
3. 新上市的股票可能需要1-2天同步

### Q: 拼音搜索为什么不准？
A: 
1. 拼音首字母搜索可能有重复（如SK匹配多个股票）
2. 建议输入更多字母提高准确度（SKKJ比SK准确）
3. 或者直接输入中文名称

### Q: 搜索结果为空怎么办？
A:
1. 检查网络连接
2. 查看浏览器控制台是否有错误
3. 尝试直接输入6位股票代码

## 验证修复成功

打开浏览器开发者工具（F12）→ Network标签：

**修复前**：
```
Request: GET /api/stocks/search?q=思看&limit=8
Response: 400 Bad Request (missing keyword parameter)
```

**修复后**：
```
Request: GET /api/stocks/search?keyword=思看&limit=8
Response: 200 OK
{
  "stocks": [
    {"code": "688583", "name": "思看科技"}
  ]
}
```

---

**现在请刷新浏览器测试！搜索"思看"应该能找到了！**
