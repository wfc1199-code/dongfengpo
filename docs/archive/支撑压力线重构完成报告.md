# 支撑压力线重构完成报告

## ✅ 重构完成

已成功实现**混合支撑压力线方案**：通达信比例 + 标准枢轴点 + 前高前低

---

## 📊 新增支撑压力线（共13条）

### 🔵 固定支撑压力线（6条 - 实线）

1. **固定阻力(7/8)** - 蓝色粗实线
   - 通达信经典公式：day_low + price_range × 7/8
   - 强度：80

2. **固定支撑(0.5/8)** - 紫色粗实线
   - 通达信经典公式：day_low + price_range × 0.5/8
   - 强度：80

3. **5日前高** - 深红色粗实线
   - 近5日最高价
   - 强度：85（短期强压力）

4. **5日前低** - 深绿色粗实线
   - 近5日最低价
   - 强度：85（短期强支撑）

5. **20日前高** - 浅红色实线
   - 近20日最高价
   - 强度：75（中期压力）

6. **20日前低** - 浅绿色实线
   - 近20日最低价
   - 强度：75（中期支撑）

---

### 🔶 动态支撑压力线（7条 - 虚线）

7. **枢轴点(PP)** - 黄色虚线
   - 标准枢轴点公式：(昨高 + 昨低 + 昨收) / 3
   - 强度：75

8. **枢轴压力(R1)** - 橙红色虚线
   - 公式：(PP × 2) - 昨低
   - 强度：70

9. **枢轴支撑(S1)** - 浅绿色虚线
   - 公式：(PP × 2) - 昨高
   - 强度：70

10. **枢轴压力(R2)** - 浅红色细虚线
    - 公式：PP + (昨高 - 昨低)
    - 强度：60

11. **枢轴支撑(S2)** - 浅绿色细虚线
    - 公式：PP - (昨高 - 昨低)
    - 强度：60

12. **动态阻力** - 红色虚线
    - 当日动态计算
    - 强度：70

13. **动态支撑** - 黄色虚线
    - 当日动态计算
    - 强度：70

---

## 🎨 视觉设计

### 线型规则
- ✅ **实线** = 固定支撑压力（基于历史数据）
- ✅ **虚线** = 动态支撑压力（实时计算）

### 颜色方案
- **支撑位**：绿色系（深绿 → 浅绿）
- **压力位**：红色系（深红 → 浅红）
- **枢轴点**：黄色/橙色
- **通达信线**：蓝色（阻力）、紫色（支撑）

### 线宽规则
- **强支撑/压力**（强度 ≥ 80）：粗线（2px）
- **中等**（强度 70-79）：中线（1.5px）
- **弱**（强度 < 70）：细线（1px）

---

## 🔧 技术实现

### 后端改动
文件：`backend/modules/stocks/support_resistance.py`

**新增方法：**
1. `calculate_pivot_points()` - 标准枢轴点计算
2. `calculate_historical_levels()` - 前高前低计算

**改进的 `calculate()` 方法：**
```python
def calculate(self, data: Dict) -> Dict:
    # 1. 通达信固定比例（7/8, 0.5/8）
    # 2. 标准枢轴点（PP, R1, R2, S1, S2）
    # 3. 前高前低（5日、20日、60日）
    # 4. 动态支撑压力（当日实时）
    
    return {
        'success': True,
        'levels': levels,  # 13条支撑压力线
        'analysis': analysis
    }
```

### 前端改动
文件：`frontend/src/hooks/useSupportResistanceTDX.ts`

**改进点：**
1. 增加K线数据获取量：5天 → **20天**
2. 智能降级方案：K线失败时，分段分时数据
3. 期权支持：分时数据分段处理
4. 更准确的动态线判断：根据 `lineStyle` 和 `type` 综合判断

---

## 📈 使用效果

### 适用场景

1. **日内交易**
   - 使用枢轴点（PP, R1, S1）快速判断日内走势
   - 动态支撑压力辅助短线操作

2. **短线交易**
   - 5日前高前低 = 强支撑压力位
   - 突破5日高点 = 买入信号
   - 跌破5日低点 = 卖出信号

3. **波段交易**
   - 20日前高前低 = 中期关键位
   - 结合枢轴点确认趋势

4. **长线交易**
   - 通达信7/8和0.5/8位置 = 长期支撑压力
   - 前高前低确认趋势反转

---

## 🎯 优势对比

### 旧方案（通达信单一方案）
- ❌ 只有7/8和0.5/8两条固定线
- ❌ 位置机械，参考价值低
- ❌ 不考虑历史关键价位

### 新方案（混合方案）
- ✅ 13条支撑压力线，多层次分析
- ✅ 结合3种成熟方法（通达信 + 枢轴点 + 前高前低）
- ✅ 固定线（实线） + 动态线（虚线）区分明确
- ✅ 国际通用标准，市场认可度高
- ✅ 适合日内、短线、波段、长线多种交易风格

---

## 🧪 测试示例

### 测试数据
股票：贵州茅台（600519）
价格：1450
20日K线数据：最高1475，最低1415

### 计算结果
```
固定阻力(7/8)      1467.50  实线  ← 通达信
固定支撑(0.5/8)    1418.75  实线  ← 通达信
枢轴点(PP)         1465.00  虚线  ← 标准枢轴点
枢轴压力(R1)       1475.00  虚线  ← 标准枢轴点
枢轴支撑(S1)       1460.00  虚线  ← 标准枢轴点
枢轴压力(R2)       1480.00  虚线  ← 标准枢轴点
枢轴支撑(S2)       1450.00  虚线  ← 标准枢轴点
5日前高           1475.00  实线  ← 前高前低
5日前低           1440.00  实线  ← 前高前低
20日前高          1475.00  实线  ← 前高前低
20日前低          1415.00  实线  ← 前高前低
动态阻力          1460.75  虚线  ← 实时计算
动态支撑          1446.12  虚线  ← 实时计算
```

---

## 📝 使用说明

### 启动查看
1. 打开分时图页面
2. 勾选"显示支撑压力线"复选框
3. 观察图表右侧的标签名称

### 标签说明
- 标签位置：固定在图表右侧
- 标签格式：`{类型} {价格}`
  - 示例：`支撑 1440.00`、`压力 1475.00`
- 标签颜色：与线条颜色一致
- 标签背景：透明（无边框）
- 防重叠：自动调整标签位置

### 线条解读
1. **实线** = 基于历史数据，相对稳定
2. **虚线** = 基于实时计算，动态变化
3. **线条越粗** = 强度越高，越重要
4. **绿色** = 支撑位（买入参考）
5. **红色** = 压力位（卖出参考）

---

## 🚀 后续优化建议

### 可选增强功能

1. **智能筛选**（如果线条太多）
   - 只显示当前价格附近±5%的线
   - 或者只显示强度 ≥ 70 的线

2. **线条交互**
   - 鼠标悬停显示详细信息
   - 点击线条显示历史触及次数

3. **斐波那契回撤**
   - 增加23.6%, 38.2%, 61.8%回撤位
   - 适合波段交易

4. **整数价位**
   - 自动识别附近整数价位
   - 心理关键位

5. **成交量密集区**
   - 基于历史成交量分布
   - 识别真实支撑压力

---

## ✨ 总结

已成功重构支撑压力线系统，从单一的通达信方案升级为**国际通用的混合方案**：

- ✅ 保留通达信经典比例（用户习惯）
- ✅ 增加标准枢轴点（国际通用）
- ✅ 增加前高前低（实际价位）
- ✅ 固定线和动态线明确区分
- ✅ 多层次、多周期支撑压力分析
- ✅ 适合多种交易风格

**现在的支撑压力线系统更专业、更实用、更准确！** 🎉
