# 支撑压力线显示问题说明

## 问题原因

有些股票没有显示**固定支撑压力线**（实线），只有**动态支撑压力线**（虚线），原因如下：

### 1. 固定支撑压力线的计算条件

后端需要以下数据才能计算固定支撑压力线：
- `high_prices`: 历史高价数组（需要多个K线数据）
- `low_prices`: 历史低价数组（需要多个K线数据）
- 价格范围 > 0（day_high - day_low > 0）

**缺少条件导致无法计算：**

#### 情况1: K线数据获取失败
```typescript
// 如果K线API请求失败，只能用分时数据
high_prices = prices;  // 分时价格
low_prices = prices;   // 相同的分时价格
```
问题：high_prices 和 low_prices 是同一个数组，导致计算结果不准确

#### 情况2: K线数据为空
```typescript
if (klineData.klines && klineData.klines.length > 0) {
  // 正常处理
} else {
  // 降级到分时数据
}
```

常见原因：
- 新股上市，历史数据不足
- 停牌股票
- 数据源问题
- 特殊代码（如期权、港股等）

#### 情况3: 期权特殊处理
```typescript
// 期权只使用当日数据
high_prices = [today_high];  // 只有1个元素
low_prices = [today_low];    // 只有1个元素
```
问题：数据点太少，无法计算有效的固定支撑压力

### 2. 动态支撑压力线的计算条件

动态线只需要当日数据：
- `current_price`: 当前价格
- `today_open`: 今日开盘价
- `today_high`: 今日最高价
- `today_low`: 今日最低价

**更容易满足条件**，所以大部分股票都有动态线

## 解决方案

### 方案1: 改进数据获取逻辑（推荐）

增加重试机制和更多降级方案：
```typescript
// 1. 尝试获取更多K线数据（20天而不是5天）
// 2. 如果失败，尝试获取60分钟K线
// 3. 如果还是失败，使用更长时间的分时数据
```

### 方案2: 显示提示信息

在UI上告知用户为什么没有固定线：
```typescript
// 如果只有动态线，显示：
// "⚠️ 历史数据不足，仅显示动态支撑压力线"
```

### 方案3: 优化后端计算逻辑

允许使用较少的数据点计算：
```python
# 当数据点少于5个时，使用备用算法
if len(high_prices) < 5:
    # 使用简化算法或扩展分时数据
```

## 当前显示规则

- **实线** = 固定支撑压力（基于历史多日K线数据）
- **虚线** = 动态支撑压力（基于当日实时数据）
- **0轴虚线** = 昨收价参考线

## 建议

1. 增加K线数据获取的 limit（从5改为20）
2. 添加数据获取失败的日志记录
3. 在前端显示数据来源和质量提示
