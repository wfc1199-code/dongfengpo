# 东风破系统全面诊断报告
> 日期: 2025-11-24 20:41

## 一、核心问题总结

### 1. 主要问题
✅ **后端API正常工作** - 端口9000监听正常
❌ **API响应时间过长** - 分时图接口响应需要21秒
❌ **前端加载卡住** - 等待超时导致"加载中"状态
❌ **WebSocket服务有错误** - 多个运行时错误

### 2. 问题根源
```
分时图切换卡住 → API响应超慢(21s) → 数据获取阻塞 → 前端等待超时
```

## 二、后端诊断结果

### 1. 服务状态
```bash
✅ 进程运行正常: PID 29529
✅ 端口监听: 9000 (localhost)
✅ API端点响应: 200 OK
❌ 响应时间: 21.4秒 (正常应 <1秒)
```

### 2. 发现的错误（从日志）
```python
# 1. StockDataManager缺少方法
'StockDataManager' object has no attribute 'get_hot_stocks'

# 2. WebSocket数据格式错误
expected string or bytes-like object, got 'dict'

# 3. 异动检测引擎初始化失败
StockAnalysisEngine.__init__() missing 1 required positional argument: 'config'

# 4. 资源泄漏
Unclosed client session (多处)
```

### 3. 性能瓶颈
- **数据获取慢**: 东方财富/新浪接口响应延迟
- **无缓存机制**: 每次都重新获取完整数据
- **同步阻塞**: 未使用异步并发获取

## 三、前端诊断结果

### 1. 配置检查
```typescript
✅ API地址正确: http://localhost:9000
✅ 端口匹配: 后端9000, 前端配置9000
✅ 分时图Y轴修复: 已正确识别科创板20%限制
```

### 2. 加载问题
```
切换股票 → 发起API请求 → 等待21秒+ → 超时/卡住 → 显示"加载中"
```

## 四、紧急修复方案

### 方案A: 快速缓存优化（推荐）
**优先级: P0 - 立即执行**
**预期效果: 响应时间从21秒降至<1秒**

#### 1. 添加Redis缓存
```python
# backend/core/cache_manager.py 已存在，需启用
from core.cache_manager import cache_manager

# 缓存分时数据，30秒过期
@cache_manager.cached(ttl=30)
async def get_timeshare_data(stock_code: str):
    ...
```

#### 2. 本地文件缓存（无需Redis）
```python
import json
from datetime import datetime, timedelta
from pathlib import Path

CACHE_DIR = Path("backend/data/cache")
CACHE_TTL = 30  # 30秒

def get_cached_timeshare(stock_code: str):
    cache_file = CACHE_DIR / f"timeshare_{stock_code}.json"
    if cache_file.exists():
        cache_time = datetime.fromtimestamp(cache_file.stat().st_mtime)
        if datetime.now() - cache_time < timedelta(seconds=CACHE_TTL):
            return json.loads(cache_file.read_text())
    return None

def save_cached_timeshare(stock_code: str, data: dict):
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    cache_file = CACHE_DIR / f"timeshare_{stock_code}.json"
    cache_file.write_text(json.dumps(data, ensure_ascii=False))
```

### 方案B: 数据源优化
**优先级: P1**

#### 1. 使用更快的数据接口
```python
# 优先级排序（速度从快到慢）
data_sources = [
    "sina",      # 新浪财经 - 最快
    "tencent",   # 腾讯财经 - 较快
    "eastmoney", # 东方财富 - 较慢
]
```

#### 2. 异步并发获取
```python
import asyncio
from aiohttp import ClientSession

async def fetch_timeshare_fast(stock_code: str):
    async with ClientSession() as session:
        tasks = [
            fetch_from_sina(session, stock_code),
            fetch_from_tencent(session, stock_code),
        ]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        # 返回第一个成功的结果
        for result in results:
            if not isinstance(result, Exception):
                return result
```

### 方案C: WebSocket实时推送
**优先级: P2**

```typescript
// 前端建立WebSocket长连接
const ws = new WebSocket('ws://localhost:9000/ws');

// 订阅股票实时数据
ws.send(JSON.stringify({
  type: 'subscribe',
  stocks: ['688291', '002864']
}));

// 接收实时更新，无需频繁请求API
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  updateChart(data);
};
```

## 五、系统架构建议

### 问题1: 数据获取层性能差
```
当前: 前端请求 → 后端 → 阻塞等待外部API(21s) → 返回
优化: 前端请求 → 后端 → 立即返回缓存(<100ms) → 后台异步更新
```

### 问题2: 无请求合并机制
```
当前: 每个组件独立请求相同数据
优化: 请求去重、数据共享
```

### 问题3: 无降级策略
```
当前: API慢 → 前端卡住
优化: API慢 → 使用旧缓存 + 提示"数据更新中"
```

## 六、立即可执行的操作

### 第1步: 启用本地文件缓存（5分钟）
```bash
# 1. 创建缓存目录
mkdir -p backend/data/cache

# 2. 在 modules/stocks/routes.py 添加缓存逻辑
# （见修复代码）

# 3. 重启后端
```

### 第2步: 优化数据获取（10分钟）
```python
# modules/stocks/routes.py
# 使用新浪财经API（最快）
async def fetch_timeshare_sina(stock_code: str):
    url = f"https://hq.sinajs.cn/list={stock_code}"
    # ... 解析返回数据
```

### 第3步: 前端超时处理（5分钟）
```typescript
// src/services/timeshare.service.ts
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 5000); // 5秒超时

try {
  const response = await fetch(url, { 
    signal: controller.signal 
  });
  clearTimeout(timeout);
} catch (error) {
  if (error.name === 'AbortError') {
    // 显示超时提示，使用缓存数据
  }
}
```

## 七、长期优化建议

### 1. 数据库设计
- 添加历史数据表
- 定时任务预加载热门股票
- 分布式缓存（Redis Cluster）

### 2. 微服务拆分
```
当前单体架构 → 按业务拆分
- 数据获取服务（专门处理外部API）
- 计算服务（支撑压力线、指标计算）
- 推送服务（WebSocket、实时警报）
```

### 3. 监控告警
- API响应时间监控
- 缓存命中率统计
- 错误日志聚合分析

## 八、需要立即修复的BUG

### 1. WebSocket服务错误
```python
# modules/websocket/service.py
# 错误: 'StockDataManager' object has no attribute 'get_hot_stocks'
# 修复: 检查并补充缺失方法
```

### 2. 资源泄漏
```python
# 所有使用 aiohttp.ClientSession 的地方
# 确保使用 async with 自动关闭
async with aiohttp.ClientSession() as session:
    ...
```

### 3. 类型错误
```python
# 错误: expected string or bytes-like object, got 'dict'
# 修复: 统一数据格式，添加类型检查
```

## 九、测试验证

### 性能测试命令
```bash
# 测试API响应时间
time curl "http://localhost:9000/api/stocks/688291/timeshare"

# 预期结果: < 1秒（使用缓存后）
```

### 压力测试
```bash
# 使用 wrk 或 ab 进行并发测试
ab -n 100 -c 10 http://localhost:9000/api/stocks/688291/timeshare
```

## 十、总结

### 核心问题
**API响应太慢** - 这是导致前端加载卡住的根本原因

### 最小可行方案（1小时可完成）
1. ✅ 添加本地文件缓存（30秒TTL）
2. ✅ 切换到新浪财经API（响应更快）
3. ✅ 前端添加5秒超时处理
4. ✅ 修复WebSocket服务错误

### 预期效果
- 首次访问: 5-10秒（外部API）
- 后续访问: <500毫秒（缓存）
- 切换股票: 流畅无卡顿

---

**建议立即执行方案A（快速缓存优化），预计1小时内可完成并生效。**
