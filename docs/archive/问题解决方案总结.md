# åˆ†æ—¶å›¾å’ŒKçº¿å›¾é—®é¢˜ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

**é—®é¢˜æè¿°**: åˆ†æ—¶å›¾å’ŒKçº¿å›¾æ˜¾ç¤ºä¸æ­£ç¡®ï¼Œå·²ç»ä¿®æ”¹å¾ˆå¤šæ¬¡ä½†ä»æœ‰é—®é¢˜

**æ ¹æœ¬åŸå› **: æ•°æ®æºåˆ‡æ¢æœºåˆ¶å­˜åœ¨ç¼ºé™·
1. ä¸»æ•°æ®æºï¼ˆä¸œæ–¹è´¢å¯Œï¼‰ç½‘ç»œä¸å¯è¾¾
2. å¤‡ç”¨æ•°æ®æºï¼ˆè…¾è®¯ï¼‰æ•°æ®ä¸å®Œæ•´ï¼ˆç¼ºå°‘æ˜¨æ”¶ä»·ï¼‰
3. æœ€ç»ˆfallbackåˆ°Mockæ•°æ®ï¼ˆä»·æ ¼ä¸¥é‡å¤±çœŸï¼‰

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. åˆ†æ—¶å›¾ä¿®å¤ âœ…

**æ–‡ä»¶**: `backend/core/data_sources.py`

**ä¿®å¤å†…å®¹**:

1. **ä¿®å¤TencentDataSource.get_realtime_data()** (ç¬¬60-65è¡Œ)
   ```python
   # åˆ›å»ºç‹¬ç«‹çš„ClientSessionï¼Œé¿å…self.sessionæœªåˆå§‹åŒ–é—®é¢˜
   timeout = aiohttp.ClientTimeout(total=5)
   async with aiohttp.ClientSession(timeout=timeout) as session:
       async with session.get(url) as response:
           text = await response.text(encoding='gbk')
           return self._parse_realtime_data(text)
   ```

2. **ä¿®å¤TencentDataSource.get_minute_data()** (ç¬¬160-188è¡Œ)
   ```python
   # ä¸»åŠ¨è·å–æ˜¨æ”¶ä»·
   try:
       realtime = await self.get_realtime_data([code])
       if realtime and code in realtime:
           stock_name = realtime[code].get('name', 'æœªçŸ¥')
           yesterday_close = realtime[code].get('yesterday_close')
   except Exception as e:
       print(f"âš ï¸ è·å–å®æ—¶æ•°æ®å¤±è´¥: {e}")
   
   # æ·»åŠ æ˜¨æ”¶ä»·åˆ°è¿”å›ç»“æœ
   result = {
       'code': code,
       'name': stock_name,
       'minute_data': minute_data
   }
   if yesterday_close is not None:
       result['yesterday_close'] = yesterday_close
   return result
   ```

**æµ‹è¯•ç»“æœ**:
```
âœ… è´µå·èŒ…å°(600519)
   - åˆ†æ—¶æ•°æ®: 242ä¸ªæ•°æ®ç‚¹
   - ä»·æ ¼: Â¥1474ï¼ˆçœŸå®æ•°æ®ï¼‰
   - æ˜¨æ”¶ä»·: Â¥1471.01ï¼ˆå·²ä¿®å¤ï¼‰
   - è‚¡ç¥¨åç§°: è´µå·èŒ…å°ï¼ˆå·²ä¿®å¤ï¼‰
```

---

## âš ï¸ å¾…ä¿®å¤é—®é¢˜

### 2. Kçº¿å›¾é—®é¢˜ âš ï¸

**ç°çŠ¶**: 
- ä¸œæ–¹è´¢å¯ŒAPIè¿æ¥å¤±è´¥
- ç›´æ¥ä½¿ç”¨Mockæ•°æ®
- Mockæ•°æ®ä¸¥é‡å¤±çœŸï¼ˆÂ¥10 vs å®é™…Â¥1471ï¼‰
- ç¼ºå°‘æ˜¨æ”¶ä»·å­—æ®µ

**éœ€è¦çš„ä¿®å¤**:

#### æ–¹æ¡ˆA: å®ç°è…¾è®¯Kçº¿æ•°æ®Fallbackï¼ˆæ¨èï¼‰

åœ¨`TencentDataSource`ä¸­æ·»åŠ Kçº¿æ•°æ®è·å–ï¼š

```python
async def get_kline_data(self, stock_code: str, period: str = 'daily', count: int = 100) -> Dict:
    """è·å–Kçº¿æ•°æ®ï¼ˆè…¾è®¯APIï¼‰"""
    # TODO: å®ç°è…¾è®¯Kçº¿APIè°ƒç”¨
    # è…¾è®¯Kçº¿API: http://web.ifzq.gtimg.cn/appstock/app/fqkline/get
    # å‚æ•°: code=sh600519, type=qfq(å‰å¤æƒ), _var=kline_dayqfq
    
    # ç¤ºä¾‹å®ç°æ¡†æ¶
    try:
        code = self._format_code(stock_code)
        url = f"http://web.ifzq.gtimg.cn/appstock/app/fqkline/get"
        params = {
            'code': code,
            'type': 'qfq',  # å‰å¤æƒ
            '_var': 'kline_dayqfq',
            'param': f'{period},{count},1'
        }
        
        timeout = aiohttp.ClientTimeout(total=10)
        async with aiohttp.ClientSession(timeout=timeout) as session:
            async with session.get(url, params=params) as response:
                text = await response.text()
                # è§£æè¿”å›æ•°æ®
                # ...
                return parsed_kline_data
    except Exception as e:
        print(f"è…¾è®¯Kçº¿è·å–å¤±è´¥: {e}")
        return None
```

ç„¶ååœ¨`StockDataManager.get_kline_data()`ä¸­æ·»åŠ Fallback:

```python
async def get_kline_data(self, stock_code: str, period: str = 'daily', count: int = 100) -> Dict:
    """è·å–Kçº¿æ•°æ®"""
    # å°è¯•ä¸œæ–¹è´¢å¯Œ
    try:
        return await self.eastmoney.get_kline_data(stock_code, period, count)
    except Exception as e:
        print(f"ä¸œæ–¹è´¢å¯ŒKçº¿å¤±è´¥: {e}")
    
    # Fallback: è…¾è®¯API
    try:
        print(f"ğŸ”„ å°è¯•è…¾è®¯Kçº¿API: {stock_code}")
        result = await self.tencent.get_kline_data(stock_code, period, count)
        if result:
            return result
    except Exception as e:
        print(f"è…¾è®¯Kçº¿å¤±è´¥: {e}")
    
    # æœ€åä½¿ç”¨Mockæ•°æ®
    return self._get_mock_kline_data(stock_code, count)
```

#### æ–¹æ¡ˆB: ä¿®å¤ä¸œæ–¹è´¢å¯ŒAPIè¿æ¥ï¼ˆæ²»æœ¬ï¼‰

1. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   # æµ‹è¯•APIå¯è¾¾æ€§
   curl -I https://push2his.eastmoney.com
   telnet push2his.eastmoney.com 443
   ```

2. **å¯èƒ½çš„ç½‘ç»œé—®é¢˜**
   - é˜²ç«å¢™é˜»æ­¢
   - IPè¢«é™åˆ¶
   - DNSè§£æé—®é¢˜
   - SSLè¯ä¹¦é—®é¢˜

3. **è§£å†³æ–¹æ¡ˆ**
   - é…ç½®HTTPä»£ç†
   - ä½¿ç”¨VPN
   - æ›´æ¢ç½‘ç»œç¯å¢ƒ
   - è”ç³»ä¸œæ–¹è´¢å¯ŒAPIæŠ€æœ¯æ”¯æŒ

---

## ğŸ”§ ç«‹å³å¯æ‰§è¡Œçš„æ­¥éª¤

### ç¬¬ä¸€æ­¥: éªŒè¯åˆ†æ—¶å›¾ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰

```bash
# é‡å¯åç«¯æœåŠ¡
cd /Users/wangfangchun/ä¸œé£ç ´/backend
python3 main_modular.py

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å‰ç«¯ï¼Œæµ‹è¯•åˆ†æ—¶å›¾æ˜¾ç¤º
# æ£€æŸ¥ï¼š
# - Yè½´èŒƒå›´æ˜¯å¦æ­£ç¡®
# - 0è½´çº¿ï¼ˆæ˜¨æ”¶ä»·ï¼‰ä½ç½®æ˜¯å¦æ­£ç¡®
# - æ¶¨è·Œå¹…ç™¾åˆ†æ¯”æ˜¯å¦å‡†ç¡®
```

### ç¬¬äºŒæ­¥: æäº¤åˆ†æ—¶å›¾ä¿®å¤ä»£ç 

```bash
cd /Users/wangfangchun/ä¸œé£ç ´

# æŸ¥çœ‹ä¿®æ”¹
git diff backend/core/data_sources.py

# æäº¤ä¿®å¤
git add backend/core/data_sources.py
git commit -m "ğŸ› ä¿®å¤: è…¾è®¯APIä½œä¸ºFallbackæ—¶ç¼ºå°‘æ˜¨æ”¶ä»·å­—æ®µ

é—®é¢˜æè¿°:
- ä¸œæ–¹è´¢å¯ŒAPIè¿æ¥å¤±è´¥æ—¶ä½¿ç”¨è…¾è®¯APIä½œä¸ºå¤‡ç”¨æ•°æ®æº
- ä½†è…¾è®¯APIè¿”å›çš„åˆ†æ—¶æ•°æ®ç¼ºå°‘yesterday_closeå­—æ®µ
- å¯¼è‡´å‰ç«¯å›¾è¡¨æ— æ³•æ­£ç¡®è®¡ç®—æ¶¨è·Œå¹…å’ŒYè½´èŒƒå›´

ä¿®å¤å†…å®¹:
1. ä¿®å¤TencentDataSource.get_realtime_data() sessionåˆå§‹åŒ–
2. åœ¨get_minute_data()ä¸­ä¸»åŠ¨è°ƒç”¨get_realtime_data()è·å–æ˜¨æ”¶ä»·
3. å°†yesterday_closeæ·»åŠ åˆ°è¿”å›æ•°æ®ç»“æ„

æµ‹è¯•éªŒè¯:
- èŒ…å°(600519): æ˜¨æ”¶ä»· Â¥1471.01 âœ…
- åˆ†æ—¶æ•°æ®: 242ä¸ªæ•°æ®ç‚¹ âœ…
- è‚¡ç¥¨åç§°: æ­£ç¡®æ˜¾ç¤º âœ…

å½±å“èŒƒå›´: æ‰€æœ‰ä½¿ç”¨è…¾è®¯API fallbackçš„åˆ†æ—¶å›¾

Co-authored-by: factory-droid[bot] <138933559+factory-droid[bot]@users.noreply.github.com>"
```

### ç¬¬ä¸‰æ­¥: ä¿®å¤Kçº¿å›¾ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆAï¼šå¿«é€Ÿæ–¹æ¡ˆ - ç¦ç”¨Mockæ•°æ®ï¼Œè¿”å›é”™è¯¯æç¤º**

```python
# ä¿®æ”¹ StockDataManager._get_mock_kline_data()
def _get_mock_kline_data(self, stock_code: str, count: int) -> Dict:
    """ä¸å†è¿”å›è¯¯å¯¼æ€§çš„Mockæ•°æ®"""
    return {
        'code': stock_code,
        'name': f'è‚¡ç¥¨{stock_code}',
        'klines': [],
        'error': 'æ•°æ®æºæš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
    }
```

**æ–¹æ¡ˆBï¼šå®Œæ•´æ–¹æ¡ˆ - å®ç°è…¾è®¯Kçº¿Fallback**ï¼ˆæ¨èä½†éœ€è¦æ›´å¤šå·¥ä½œï¼‰

å‚è€ƒä¸Šé¢"æ–¹æ¡ˆA"çš„å®ç°ä»£ç ã€‚

### ç¬¬å››æ­¥: è°ƒæŸ¥ç½‘ç»œé—®é¢˜

```bash
# 1. æµ‹è¯•ä¸œæ–¹è´¢å¯ŒAPI
curl -v https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=1.600519

# 2. æ£€æŸ¥DNS
nslookup push2his.eastmoney.com
nslookup push2.eastmoney.com

# 3. æµ‹è¯•å…¶ä»–endpoint
curl -I https://push2.eastmoney.com

# 4. æ£€æŸ¥é˜²ç«å¢™æ—¥å¿—ï¼ˆmacOSï¼‰
sudo log show --predicate 'process == "socketfilterfw"' --last 1h

# 5. ä¸´æ—¶ç¦ç”¨é˜²ç«å¢™æµ‹è¯•ï¼ˆå°å¿ƒï¼ï¼‰
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
# æµ‹è¯•å®Œåè®°å¾—é‡æ–°å¯ç”¨
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
```

---

## ğŸ“Š ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„è®¡å·¥ä½œé‡ | å½±å“ |
|--------|------|-----------|------|
| ğŸ”´ **P0** | éªŒè¯åˆ†æ—¶å›¾ä¿®å¤ | 5åˆ†é’Ÿ | ç«‹å³æ”¹å–„ç”¨æˆ·ä½“éªŒ |
| ğŸ”´ **P0** | æäº¤åˆ†æ—¶å›¾ä»£ç  | 5åˆ†é’Ÿ | ä¿å­˜ä¿®å¤æˆæœ |
| ğŸŸ  **P1** | ç¦ç”¨è¯¯å¯¼æ€§Mockæ•°æ® | 10åˆ†é’Ÿ | é¿å…ç”¨æˆ·çœ‹åˆ°é”™è¯¯æ•°æ® |
| ğŸŸ¡ **P2** | è°ƒæŸ¥ç½‘ç»œé—®é¢˜ | 30-60åˆ†é’Ÿ | æ ¹æœ¬è§£å†³è¿æ¥é—®é¢˜ |
| ğŸŸ¢ **P3** | å®ç°è…¾è®¯Kçº¿Fallback | 2-4å°æ—¶ | å®Œå–„å¤‡ç”¨æ–¹æ¡ˆ |

---

## ğŸ¯ é•¿æœŸæ”¹è¿›å»ºè®®

### 1. æ•°æ®æºæ¶æ„æ”¹è¿›

```python
class DataSourceStrategy:
    """æ•°æ®æºç­–ç•¥æ¨¡å¼"""
    
    def __init__(self):
        self.sources = [
            EastMoneyDataSource(priority=1),
            TencentDataSource(priority=2),
            SinaDataSource(priority=3),  # å¯ä»¥æ·»åŠ æ–°æµªè´¢ç»
            # NetEaseDataSource(priority=4),  # ç½‘æ˜“è´¢ç»
        ]
    
    async def fetch_with_fallback(self, method: str, *args, **kwargs):
        """å¸¦Fallbackçš„æ•°æ®è·å–"""
        last_error = None
        
        for source in sorted(self.sources, key=lambda s: s.priority):
            try:
                result = await getattr(source, method)(*args, **kwargs)
                if self._validate_data(result):
                    return result
            except Exception as e:
                last_error = e
                logger.warning(f"{source.name} å¤±è´¥: {e}")
        
        raise Exception(f"æ‰€æœ‰æ•°æ®æºéƒ½å¤±è´¥: {last_error}")
```

### 2. æ•°æ®éªŒè¯

```python
def validate_minute_data(data: Dict) -> Tuple[bool, str]:
    """éªŒè¯åˆ†æ—¶æ•°æ®å®Œæ•´æ€§"""
    if not data:
        return False, "æ•°æ®ä¸ºç©º"
    
    required = ['code', 'name', 'minute_data', 'yesterday_close']
    missing = [f for f in required if f not in data or data[f] is None]
    
    if missing:
        return False, f"ç¼ºå°‘å­—æ®µ: {', '.join(missing)}"
    
    if len(data['minute_data']) == 0:
        return False, "åˆ†æ—¶æ•°æ®ä¸ºç©º"
    
    # æ£€æŸ¥ä»·æ ¼åˆç†æ€§
    prices = [p['price'] for p in data['minute_data']]
    if max(prices) / min(prices) > 1.15:  # å•æ—¥æ¶¨è·Œå¹…ä¸åº”è¶…è¿‡15%
        return False, "ä»·æ ¼æ³¢åŠ¨å¼‚å¸¸"
    
    return True, "æ•°æ®æœ‰æ•ˆ"
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```python
import logging
from datetime import datetime, timedelta

class DataSourceMonitor:
    """æ•°æ®æºç›‘æ§"""
    
    def __init__(self):
        self.failure_counts = {}
        self.last_success = {}
    
    def record_failure(self, source: str):
        """è®°å½•å¤±è´¥"""
        self.failure_counts[source] = self.failure_counts.get(source, 0) + 1
        
        # è¿ç»­å¤±è´¥5æ¬¡ï¼Œå‘é€å‘Šè­¦
        if self.failure_counts[source] >= 5:
            self._send_alert(f"{source} è¿ç»­å¤±è´¥ {self.failure_counts[source]} æ¬¡")
    
    def record_success(self, source: str):
        """è®°å½•æˆåŠŸ"""
        self.failure_counts[source] = 0
        self.last_success[source] = datetime.now()
    
    def _send_alert(self, message: str):
        """å‘é€å‘Šè­¦ï¼ˆå¯ä»¥æ¥å…¥é’‰é’‰/ä¼ä¸šå¾®ä¿¡/é‚®ä»¶ï¼‰"""
        logging.error(f"âš ï¸ æ•°æ®æºå‘Šè­¦: {message}")
        # TODO: æ¥å…¥å®é™…å‘Šè­¦ç³»ç»Ÿ
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åˆ†æ—¶å›¾Kçº¿å›¾ä¿®å¤æŠ¥å‘Š.md](./åˆ†æ—¶å›¾Kçº¿å›¾ä¿®å¤æŠ¥å‘Š.md) - è¯¦ç»†çš„æŠ€æœ¯åˆ†æå’Œä¿®å¤è¿‡ç¨‹
- [docs/åˆ†æ—¶æ•°æ®å¤„ç†ä¸­å¿ƒé‡æ„æ–¹æ¡ˆ.md](./docs/åˆ†æ—¶æ•°æ®å¤„ç†ä¸­å¿ƒé‡æ„æ–¹æ¡ˆ.md) - ç³»ç»Ÿæ¶æ„æ–‡æ¡£
- [NETWORK_CONNECTIVITY_ISSUE.md](./NETWORK_CONNECTIVITY_ISSUE.md) - ç½‘ç»œè¿æ¥é—®é¢˜è®°å½•

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å®Œæˆæ‰€æœ‰ä¿®å¤åï¼Œè¯·éªŒè¯ï¼š

- [ ] åˆ†æ—¶å›¾æ˜¾ç¤ºæ­£å¸¸
  - [ ] Yè½´èŒƒå›´æ­£ç¡®
  - [ ] 0è½´çº¿ï¼ˆæ˜¨æ”¶ä»·ï¼‰ä½ç½®æ­£ç¡®
  - [ ] æ¶¨è·Œå¹…ç™¾åˆ†æ¯”å‡†ç¡®
  - [ ] ä»·æ ¼æ•°æ®çœŸå®
  
- [ ] Kçº¿å›¾æ˜¾ç¤ºæ­£å¸¸
  - [ ] æ—¥Kçº¿æ•°æ®çœŸå®
  - [ ] æ˜¨æ”¶ä»·å­—æ®µå­˜åœ¨
  - [ ] ä¸å†æ˜¾ç¤ºMockæ•°æ®
  
- [ ] ä»£ç è´¨é‡
  - [ ] å·²æäº¤åˆ°Git
  - [ ] æ·»åŠ äº†å¿…è¦çš„æ—¥å¿—
  - [ ] é”™è¯¯å¤„ç†å®Œå–„
  
- [ ] æ–‡æ¡£æ›´æ–°
  - [ ] ä¿®å¤è®°å½•å®Œæ•´
  - [ ] æ›´æ–°ç³»ç»Ÿæ–‡æ¡£

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-19  
**çŠ¶æ€**: åˆ†æ—¶å›¾å·²ä¿®å¤âœ… / Kçº¿å›¾å¾…ä¿®å¤âš ï¸
