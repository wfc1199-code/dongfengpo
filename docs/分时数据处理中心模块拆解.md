## 分时数据处理中心模块拆解

### 1. 服务拓扑
| 层级 | 服务/模块 | 主要职责 | 关键输入 | 关键输出 | 负责人(待定) |
| --- | --- | --- | --- | --- | --- |
| 数据层 | `collector-gateway` | 多源分时行情采集、重试、节流 | 证券数据源 (HTTP/WebSocket) | 原始 Tick Stream |  |
| 数据层 | `stream-buffer` | 流数据缓冲、重放、分发 | 原始 Tick Stream | 标准化 Topic |  |
| 数据层 | `data-cleaner` | 清洗对齐、异常修正、特征补齐 | Topic 数据 | 规范化 Tick / Snapshot |  |
| 数据层 | `data-lake-writer` | 落历史库、归档、版本管理 | 标准化数据 | Parquet/ClickHouse |  |
| 分析层 | `feature-pipeline` | 特征计算、指标聚合 | 规范化 Tick | FeatureSnapshot |  |
| 分析层 | `strategy-engine` | 策略插件执行、信号评分 | FeatureSnapshot、配置 | 原始策略信号 |  |
| 分析层 | `opportunity-aggregator` | 多策略去重合并、生命周期管理 | 策略信号 | OpportunitySignal |  |
| 服务层 | `signal-api` | REST 查询、信号订阅控制 | OpportunitySignal | API Response |  |
| 服务层 | `signal-streamer` | WebSocket 推送、主题订阅 | OpportunitySignal | Stream Payload |  |
| 服务层 | `backtest-service` | 历史回测、参数扫描、报表 | 历史数据、策略配置 | 回测报告 |  |
| 服务层 | `risk-guard` | 风控策略、风险提示 | Opportunity / 市场数据 | 风险标签、告警 |  |
| 体验层 | `trading-dashboard` | 实时机会面板、策略管理 | API/Stream 数据 | UI 展示 |  |
| 体验层 | `strategy-workbench` | 策略调优、参数管理、回测可视化 | 回测结果 | 运营页面 |  |

### 2. 数据契约与 Schema
- `TickRecord`: 基础行情 (时间、价格、成交量、成交额、买卖盘口)。
- `FeatureSnapshot`: 聚合特征 (涨速、量比、资金流、板块热度、盘口压力、波动率)。
- `StrategySignal`: 单策略输出 (策略标识、信号类型、置信度、相关指标)。
- `OpportunitySignal`: 聚合结果 (证券代码、机会类型、进入价区、目标价、止损、置信度、策略贡献、生命周期状态)。
- `RiskAlert`: 风险事件 (类型、触发条件、关联机会、建议动作)。

所有 Schema 使用 Pydantic 定义，统一收敛在 `libs/data_contracts` 包中，可通过可编辑安装被各服务直接引入，并生成 OpenAPI 规范与前端 TypeScript 类型。

### 3. 分阶段任务拆分
#### P0 数据骨架
1. **数据源适配器**
   - 抽象 `DataSourceAdapter` 接口（订阅、拉取、节流、解析）。
   - 实现东方财富、腾讯数据源，并保留 Tushare 备份。
   - 统一错误/重试/日志策略。
2. **数据采集服务**
   - 新建 `collector-gateway`（FastAPI + asyncio），多协程抓取后推送 Redis Stream。
   - 实现心跳监控、延迟统计、异常报警。
3. **数据清洗模块**
   - 编写 `data-cleaner` 消费 Stream，完成时间对齐、缺失补偿、异常纠偏。
   - 输出到 `clean-tick` Topic 与实时缓存 Redis Hash。
4. **数据湖写入**
   - 设计 Parquet/ClickHouse 表结构，落历史数据。
   - 搭建批量落地任务（Prefect/Airflow）。

#### P1 机会引擎 MVP
1. **特征流水线**
   - 构建 `feature-pipeline` 服务，计算关键指标：涨速、成交量增量、盘口强度、板块热度、主动资金。
   - 支持多频率 (1s / 5s / 1min) 计算。
2. **策略框架**
   - 定义策略生命周期接口（初始化→执行→输出→复位）。
   - 策略配置中心（YAML/JSON + 热加载）。
3. **首批策略实现**
   - `StrategyRapidRise`: 短时涨速 + 量价背离 + 盘口强度。
   - `StrategySectorRotation`: 板块指数/热度协同提升。
   - `StrategyCapitalSurge`: 主动买入占比 + 大单密度突增。
4. **机会聚合器**
   - 将多策略信号按个股聚合，计算综合评分，去重冲突。
   - 维护机会状态机：`NEW` → `ACTIVE` → `TRACKING` → `CLOSED/CANCELLED`。
5. **信号输出**
   - 新建 `signal-api` 提供查询、过滤、订阅控制。
   - 新建 `signal-streamer` 提供 WebSocket/Server-Sent Events 推送。
6. **基础前端展示**
   - 在现有前端中加入「机会列表」「策略贡献」「实时信号」模块占位。

#### P2 回测与评估（概要）
- 历史数据回放引擎、策略沙箱、回测报表、指标计算、参数切换管理。

### 4. 跨阶段支持工作
- **配置中心**：集中管理数据源、策略、风控、阈值配置，支持环境差异。
- **监控告警**：Prometheus 指标、Grafana 仪表盘、告警规则（延迟、异常率、信号数量、服务健康）。
- **CI/CD**：
  - 后端：pytest + mypy + black/isort；GitHub Actions/自建流水线。
  - 前端：ESLint + TypeScript 检查 + Vitest/Jest。
  - Docker 镜像发布，支持蓝绿/灰度。
- **文档**：架构图、数据契约、策略说明、部署手册持续维护。

### 5. 角色与协作建议
- **数据工程**：负责数据源、清洗、数据湖。
- **策略工程**：负责特征、策略框架与策略实现。
- **后端工程**：负责信号服务、API/推送、配置中心。
- **前端工程**：负责 UI 重构、实时看板、策略管理。
- **QA/测试**：搭建自动化用例、策略回测验证、性能测试。
- **产品/运营**：定义机会标准、策略优先级、指标监控。

> 本文档用于指导各子团队拆解任务，需伴随项目推进实时更新负责人与交付时间。
