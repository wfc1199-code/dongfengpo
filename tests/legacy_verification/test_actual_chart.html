<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>实际分时图诊断 - 688155</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; margin: 0; padding: 20px; font-family: Arial; }
        .container { display: flex; gap: 20px; }
        #chart { flex: 1; height: 500px; border: 1px solid #333; }
        .info { width: 300px; padding: 20px; background: #222; border-radius: 8px; }
        .error { color: #ff4444; font-weight: bold; }
        .correct { color: #4CAF50; }
        .warning { color: #FFA500; }
    </style>
</head>
<body>
    <h2>实际分时图问题诊断</h2>
    <div class="container">
        <div id="chart"></div>
        <div class="info">
            <h3>诊断信息</h3>
            <div id="diagnosis"></div>
        </div>
    </div>
    
    <script>
        async function diagnose() {
            const response = await fetch('http://localhost:9000/api/stocks/688155/timeshare');
            const data = await response.json();
            
            const yesterdayClose = data.yesterday_close;
            const timeshareData = data.timeshare_data || [];
            
            // 提取数据
            const times = [];
            const prices = [];
            timeshareData.forEach(item => {
                times.push(item.time);
                prices.push(item.price);
            });
            
            // 计算各种Y轴范围方案
            const validPrices = prices.filter(p => p > 0);
            const maxPrice = Math.max(...validPrices);
            const minPrice = Math.min(...validPrices);
            
            // 方案1：原始代码的计算方式
            const allPrices1 = [...validPrices, yesterdayClose].filter(p => p > 0);
            const adjustedMax1 = Math.max(maxPrice, yesterdayClose);
            const adjustedMin1 = Math.min(minPrice, yesterdayClose);
            const priceRange1 = adjustedMax1 - adjustedMin1;
            const yAxisMax1 = adjustedMax1 + priceRange1 * 0.1;
            const yAxisMin1 = adjustedMin1 - priceRange1 * 0.1;
            
            // 方案2：可能的错误计算（如果yesterdayClose为0或undefined）
            const wrongYesterdayClose = 0;  // 模拟错误情况
            const yAxisMax2 = wrongYesterdayClose * 1.1 || maxPrice * 1.1;
            const yAxisMin2 = wrongYesterdayClose * 0.9 || minPrice * 0.9;
            
            // 方案3：正确的对称计算
            const maxDiff = Math.max(
                Math.abs(maxPrice - yesterdayClose),
                Math.abs(minPrice - yesterdayClose)
            );
            const yAxisMax3 = yesterdayClose + maxDiff * 1.1;
            const yAxisMin3 = yesterdayClose - maxDiff * 1.1;
            
            // 诊断信息
            document.getElementById('diagnosis').innerHTML = `
                <div><strong>API数据：</strong></div>
                <div>昨收价: <span class="correct">${yesterdayClose}</span></div>
                <div>价格范围: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}</div>
                <div>数据点数: ${prices.length}</div>
                <br>
                <div><strong>Y轴计算方案对比：</strong></div>
                <div class="${yAxisMin1 > 50 ? 'error' : 'correct'}">
                    方案1(当前): ${yAxisMin1.toFixed(2)} - ${yAxisMax1.toFixed(2)}
                </div>
                <div class="warning">
                    方案2(错误): ${yAxisMin2.toFixed(2)} - ${yAxisMax2.toFixed(2)}
                </div>
                <div class="correct">
                    方案3(对称): ${yAxisMin3.toFixed(2)} - ${yAxisMax3.toFixed(2)}
                </div>
                <br>
                <div><strong>问题分析：</strong></div>
                ${yAxisMin1 > yesterdayClose ? '<div class="error">Y轴最小值大于昨收价！</div>' : ''}
                ${yAxisMin1 < 20 ? '<div class="error">Y轴最小值异常低（可能导致0轴显示在底部）</div>' : ''}
                ${Math.abs(yAxisMin1 - 12.48) < 1 ? '<div class="error">Y轴最小值接近12.48（与截图一致）</div>' : ''}
            `;
            
            // 绘制图表（使用可能有问题的计算方式）
            const chart = echarts.init(document.getElementById('chart'));
            const option = {
                title: { 
                    text: '模拟实际分时图的问题', 
                    textStyle: { color: '#fff' } 
                },
                backgroundColor: '#1a1a1a',
                grid: {
                    left: 80,
                    right: 80,
                    top: 60,
                    bottom: 80
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#999', interval: 30 }
                },
                yAxis: [
                    {
                        type: 'value',
                        position: 'left',
                        min: yAxisMin1,  // 使用可能有问题的计算
                        max: yAxisMax1,
                        axisLine: { lineStyle: { color: '#555' } },
                        axisLabel: { color: '#999', formatter: v => v.toFixed(2) },
                        splitLine: { lineStyle: { color: '#333', type: 'dashed' } }
                    },
                    {
                        type: 'value',
                        position: 'right',
                        min: yAxisMin1,
                        max: yAxisMax1,
                        axisLine: { lineStyle: { color: '#555' } },
                        axisLabel: { 
                            color: '#999',
                            formatter: v => {
                                const pct = ((v - yesterdayClose) / yesterdayClose * 100);
                                return `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
                            }
                        }
                    }
                ],
                series: [{
                    type: 'line',
                    data: prices,
                    smooth: false,
                    symbol: 'none',
                    lineStyle: { color: '#00bfff', width: 2 },
                    markLine: {
                        data: [
                            {
                                yAxis: yesterdayClose,
                                lineStyle: { color: '#fff', type: 'dashed', width: 2 },
                                label: {
                                    formatter: `昨收 ${yesterdayClose.toFixed(2)}`,
                                    position: 'end',
                                    color: '#fff'
                                }
                            },
                            // 显示Y轴最小值位置
                            {
                                yAxis: yAxisMin1,
                                lineStyle: { color: '#ff4444', type: 'dotted', width: 1 },
                                label: {
                                    formatter: `Y轴最小 ${yAxisMin1.toFixed(2)}`,
                                    position: 'start',
                                    color: '#ff4444'
                                }
                            }
                        ]
                    }
                }]
            };
            
            chart.setOption(option);
            
            console.log('诊断结果:', {
                昨收价: yesterdayClose,
                价格范围: [minPrice, maxPrice],
                Y轴范围: [yAxisMin1, yAxisMax1],
                问题: yAxisMin1 < 20 ? 'Y轴最小值异常低' : '正常'
            });
        }
        
        diagnose();
    </script>
</body>
</html>