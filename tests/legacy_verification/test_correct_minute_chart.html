<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸæƒåˆ†æ—¶å›¾ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
            font-size: 14px;
        }
        button:hover { opacity: 0.8; }
        .controls {
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .data-sample {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .data-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        .data-item strong {
            color: #007bff;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœŸæƒåˆ†æ—¶å›¾ä¿®å¤æµ‹è¯•</h1>

        <div class="controls">
            <button onclick="testMO2511Call()">ğŸ“ˆ æµ‹è¯• MO2511-C-7500 (çœ‹æ¶¨)</button>
            <button onclick="testMO2511Put()">ğŸ“‰ æµ‹è¯• MO2511-P-7500 (çœ‹è·Œ)</button>
            <button onclick="clearChart()">ğŸ—‘ï¸ æ¸…ç©ºå›¾è¡¨</button>
        </div>

        <div id="status" class="status info">ç­‰å¾…æµ‹è¯•...</div>

        <div class="section">
            <h3>ğŸ“Š åˆ†æ—¶å›¾æ˜¾ç¤º</h3>
            <div id="minuteChart" class="chart-container"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ æ•°æ®æ ·æœ¬</h3>
            <div id="dataSample" class="data-sample">æ— æ•°æ®</div>
        </div>

        <div class="section">
            <h3>ğŸ”§ APIåŸå§‹å“åº”</h3>
            <pre id="rawResponse">ç­‰å¾…APIè°ƒç”¨...</pre>
        </div>

        <div class="section">
            <h3>ğŸ” æ•°æ®åˆ†æ</h3>
            <div id="dataAnalysis">æ— åˆ†æ</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9000/api/options';
        let chart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            chart = echarts.init(document.getElementById('minuteChart'));
            window.addEventListener('resize', () => chart.resize());
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        // æµ‹è¯•çœ‹æ¶¨æœŸæƒ
        async function testMO2511Call() {
            await testOptionMinuteData('MO2511-C-7500', 'ä¸­è¯1000çœ‹æ¶¨æœŸæƒ');
        }

        // æµ‹è¯•çœ‹è·ŒæœŸæƒ
        async function testMO2511Put() {
            await testOptionMinuteData('MO2511-P-7500', 'ä¸­è¯1000çœ‹è·ŒæœŸæƒ');
        }

        // æµ‹è¯•æœŸæƒåˆ†æ—¶æ•°æ®
        async function testOptionMinuteData(optionCode, optionName) {
            showStatus(`æ­£åœ¨è·å– ${optionName} åˆ†æ—¶æ•°æ®...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/${optionCode}/minute`);
                const data = await response.json();

                // æ˜¾ç¤ºåŸå§‹å“åº”
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);

                if (response.ok && data.status === 'success') {
                    const minuteData = data.minute_data || data.data || [];

                    if (minuteData && minuteData.length > 0) {
                        showStatus(`âœ… æˆåŠŸè·å– ${minuteData.length} æ¡åˆ†æ—¶æ•°æ®`, 'success');
                        analyzeAndDisplayData(data, minuteData);
                    } else {
                        showStatus('âŒ æ²¡æœ‰åˆ†æ—¶æ•°æ®', 'error');
                    }
                } else {
                    showStatus(`âŒ è·å–å¤±è´¥: ${data.message || data.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showStatus(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                document.getElementById('rawResponse').textContent = `ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        // åˆ†æå¹¶æ˜¾ç¤ºæ•°æ®
        function analyzeAndDisplayData(apiResponse, minuteData) {
            // æ•°æ®åˆ†æ
            const times = minuteData.map(item => item.time);
            const prices = minuteData.map(item => item.price);
            const volumes = minuteData.map(item => item.volume);

            const firstTime = times[0];
            const lastTime = times[times.length - 1];
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);

            const priceChange = ((lastPrice - firstPrice) / firstPrice * 100).toFixed(2);

            // æ˜¾ç¤ºåˆ†æç»“æœ
            const analysis = `
                <strong>ğŸ“Š æ•°æ®ç»Ÿè®¡:</strong><br>
                æœŸæƒä»£ç : ${apiResponse.code}<br>
                æ•°æ®æ¥æº: ${apiResponse.source || apiResponse.note || 'æœªçŸ¥'}<br>
                æ•°æ®ç‚¹æ•°: ${minuteData.length}<br>
                æ—¶é—´èŒƒå›´: ${firstTime} - ${lastTime}<br>
                ä»·æ ¼èŒƒå›´: Â¥${minPrice.toFixed(4)} - Â¥${maxPrice.toFixed(4)}<br>
                æ¶¨è·Œå¹…: ${priceChange}%<br>
                æ•°æ®æ—¥æœŸ: ${apiResponse.data_date || 'ä»Šæ—¥'}<br><br>

                <strong>âœ… éªŒè¯ç»“æœ:</strong><br>
                æ—¶é—´æ ¼å¼: ${/^\d{2}:\d{2}$/.test(firstTime) ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}<br>
                ä»·æ ¼åˆç†æ€§: ${firstPrice > 10 && firstPrice < 200 ? 'âœ… åˆç†' : 'âŒ å¼‚å¸¸'}<br>
                æ•°æ®å®Œæ•´æ€§: ${minuteData.length > 50 ? 'âœ… å……åˆ†' : 'âŒ ä¸å……åˆ†'}
            `;
            document.getElementById('dataAnalysis').innerHTML = analysis;

            // æ˜¾ç¤ºæ•°æ®æ ·æœ¬
            const sampleHtml = minuteData.slice(0, 8).map((item, index) => `
                <div class="data-item">
                    <strong>${item.time}</strong><br>
                    Â¥${item.price.toFixed(4)}<br>
                    ${item.change_percent > 0 ? '+' : ''}${item.change_percent}%<br>
                    Vol: ${item.volume}
                </div>
            `).join('');
            document.getElementById('dataSample').innerHTML = sampleHtml;

            // ç»˜åˆ¶å›¾è¡¨
            drawChart(minuteData);
        }

        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(minuteData) {
            if (!chart) {
                initChart();
            }

            const times = minuteData.map(item => item.time);
            const prices = minuteData.map(item => item.price);
            const volumes = minuteData.map(item => item.volume);

            const option = {
                title: {
                    text: `æœŸæƒåˆ†æ—¶å›¾ (${minuteData.length}ä¸ªæ•°æ®ç‚¹)`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        const price = params[0].data;
                        const volume = params[1] ? params[1].data : 0;
                        return `æ—¶é—´: ${time}<br/>ä»·æ ¼: Â¥${price.toFixed(4)}<br/>æˆäº¤é‡: ${volume}`;
                    }
                },
                legend: {
                    data: ['ä»·æ ¼', 'æˆäº¤é‡'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 20)
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ä»·æ ¼ (å…ƒ)',
                        position: 'left',
                        scale: true,
                        axisLabel: {
                            formatter: 'Â¥{value}'
                        }
                    },
                    {
                        type: 'value',
                        name: 'æˆäº¤é‡',
                        position: 'right',
                        scale: true
                    }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: prices,
                        smooth: true,
                        lineStyle: {
                            width: 2
                        },
                        itemStyle: {
                            color: '#ff4757'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(255, 71, 87, 0.3)' },
                                    { offset: 1, color: 'rgba(255, 71, 87, 0.1)' }
                                ]
                            }
                        }
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: 'rgba(52, 152, 219, 0.6)'
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    }
                ]
            };

            chart.setOption(option, true);
        }

        // æ¸…ç©ºå›¾è¡¨
        function clearChart() {
            if (chart) {
                chart.clear();
            }
            document.getElementById('status').className = 'status info';
            document.getElementById('status').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('rawResponse').textContent = 'ç­‰å¾…APIè°ƒç”¨...';
            document.getElementById('dataSample').innerHTML = 'æ— æ•°æ®';
            document.getElementById('dataAnalysis').innerHTML = 'æ— åˆ†æ';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
        });
    </script>
</body>
</html>