<!DOCTYPE html>
<html>
<head>
    <title>Exact FetchData Test</title>
</head>
<body>
    <h1>æ¨¡æ‹ŸReact Appçš„fetchDataå‡½æ•°</h1>
    <div id="result"></div>
    <button onclick="testFetchData()">é‡æ–°æµ‹è¯•</button>
    
    <script>
        async function testFetchData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
            
            try {
                console.log('å¼€å§‹æµ‹è¯•fetchDataå‡½æ•°...');
                
                // 1. å¹¶è¡Œè·å–å¼‚åŠ¨æ•°æ®å’Œè‡ªé€‰è‚¡æ•°æ® (exactly like React app)
                const [anomalyResponse, configResponse] = await Promise.all([
                    fetch(`http://localhost:9000/api/anomaly/detect-legacy?scan_all=true`),
                    fetch('http://localhost:9000/api/config')
                ]);
                
                console.log('å¼‚åŠ¨APIå“åº”:', anomalyResponse.status);
                console.log('é…ç½®APIå“åº”:', configResponse.status);
                
                let output = '<h2>æµ‹è¯•ç»“æœ:</h2>';
                
                // 2. å¤„ç†å¼‚åŠ¨æ•°æ®
                if (anomalyResponse.ok) {
                    const responseData = await anomalyResponse.json();
                    output += `<p style="color: green;">âœ… å¼‚åŠ¨æ£€æµ‹æˆåŠŸ: ${responseData.anomalies?.length || 0} ä¸ªå¼‚åŠ¨</p>`;
                    console.log('å¼‚åŠ¨æ•°æ®:', responseData);
                } else {
                    output += `<p style="color: red;">âŒ å¼‚åŠ¨æ£€æµ‹å¤±è´¥: ${anomalyResponse.status}</p>`;
                }
                
                // 3. å¤„ç†è‡ªé€‰è‚¡æ•°æ®
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    const favoriteStocks = config?.user_customization?.è‡ªå®šä¹‰ç›‘æ§?.è‡ªé€‰è‚¡ç¥¨æ±  || [];
                    output += `<p style="color: green;">âœ… é…ç½®è·å–æˆåŠŸ: ${favoriteStocks.length} åªè‡ªé€‰è‚¡</p>`;
                    console.log('é…ç½®æ•°æ®:', config);
                    console.log('è‡ªé€‰è‚¡:', favoriteStocks);
                    
                    if (favoriteStocks.length > 0) {
                        // 4. è·å–è‡ªé€‰è‚¡çš„å®æ—¶æ•°æ® (exactly like React app)
                        const stockDataPromises = favoriteStocks.map(async (code) => {
                            try {
                                console.log(`è·å–è‚¡ç¥¨ ${code} æ•°æ®...`);
                                const response = await fetch(`http://localhost:9000/api/stocks/${code}/realtime`);
                                if (response.ok) {
                                    const result = await response.json();
                                    const data = result.data || result;
                                    const stockCode = result.code || data.code || code;
                                    
                                    return {
                                        code: stockCode,
                                        name: data.name || data.stock_name || `æœªçŸ¥${code}`,
                                        price: data.current_price || data.price || 0,
                                        change: data.change || 0,
                                        changePercent: data.change_percent || data.changePercent || 0,
                                        volume: data.volume || 0,
                                        amount: data.amount || 0,
                                        turnoverRate: data.turnoverRate || 0
                                    };
                                } else {
                                    console.warn(`è‚¡ç¥¨ ${code} APIå“åº”å¤±è´¥:`, response.status);
                                    return null;
                                }
                            } catch (error) {
                                console.warn(`è·å–è‚¡ç¥¨ ${code} æ•°æ®å¤±è´¥:`, error);
                                throw error; // Re-throw to trigger outer catch
                            }
                        });
                        
                        const stockResults = await Promise.all(stockDataPromises);
                        const validStocks = stockResults.filter(stock => stock !== null);
                        output += `<p style="color: green;">âœ… è‚¡ç¥¨æ•°æ®è·å–æˆåŠŸ: ${validStocks.length}/${favoriteStocks.length} åªè‚¡ç¥¨</p>`;
                        
                        validStocks.forEach(stock => {
                            output += `<p>ğŸ“ˆ ${stock.name} (${stock.code}): ${stock.price} ${stock.changePercent > 0 ? '+' : ''}${stock.changePercent.toFixed(2)}%</p>`;
                        });
                    } else {
                        output += `<p style="color: orange;">âš ï¸ æ²¡æœ‰è‡ªé€‰è‚¡é…ç½®</p>`;
                    }
                } else {
                    output += `<p style="color: red;">âŒ é…ç½®è·å–å¤±è´¥: ${configResponse.status}</p>`;
                }
                
                output += `<p style="color: green;">âœ… fetchDataæ‰§è¡ŒæˆåŠŸ</p>`;
                resultDiv.innerHTML = output;
                
            } catch (error) {
                console.error('fetchDataå¤±è´¥:', error);
                resultDiv.innerHTML = `<p style="color: red;">âŒ fetchDataå¤±è´¥: ${error.message}</p><p>é”™è¯¯è¯¦æƒ…: ${error.stack}</p>`;
            }
        }
        
        // è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•
        testFetchData();
    </script>
</body>
</html>