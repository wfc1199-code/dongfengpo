<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªé€‰è‚¡åˆ é™¤æŒ‰é’®æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #e5e5e5; }
        .test-section { border: 1px solid #444; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .test-title { font-weight: bold; color: #4fc3f7; margin-bottom: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #2e7d32; color: white; }
        .error { background: #d32f2f; color: white; }
        .info { background: #1976d2; color: white; }
        .favorite-list { background: #2a2a2a; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .favorite-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #444;
        }
        .delete-btn { 
            background: #d32f2f; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 3px; 
            cursor: pointer;
        }
        .delete-btn:hover { background: #f44336; }
        .add-section { margin: 15px 0; }
        .add-input { padding: 8px; margin-right: 10px; background: #333; color: white; border: 1px solid #555; }
        .add-btn { background: #4caf50; color: white; border: none; padding: 8px 15px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ—‘ï¸ è‡ªé€‰è‚¡åˆ é™¤æŒ‰é’®æµ‹è¯•</h1>
    
    <div class="test-section">
        <div class="test-title">å½“å‰é…ç½®çŠ¶æ€</div>
        <div id="config-status">æ­£åœ¨æ£€æŸ¥é…ç½®...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">è‡ªé€‰è‚¡åˆ—è¡¨</div>
        <div id="favorites-list">æ­£åœ¨åŠ è½½...</div>
        
        <div class="add-section">
            <input type="text" id="stock-input" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: 000001)" class="add-input">
            <button onclick="addFavorite()" class="add-btn">æ·»åŠ è‡ªé€‰è‚¡</button>
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">APIæµ‹è¯•ç»“æœ</div>
        <div id="api-results">
            <button onclick="testGetConfig()" style="margin: 5px; padding: 8px 15px;">æµ‹è¯•è·å–é…ç½®</button>
            <button onclick="testAddFavorite()" style="margin: 5px; padding: 8px 15px;">æµ‹è¯•æ·»åŠ </button>
            <button onclick="testDeleteFavorite()" style="margin: 5px; padding: 8px 15px;">æµ‹è¯•åˆ é™¤</button>
        </div>
        <div id="test-output"></div>
    </div>

    <script>
        let currentFavorites = [];
        
        // åŠ è½½å½“å‰é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('http://localhost:9000/api/config');
                const config = await response.json();
                
                console.log('é…ç½®æ•°æ®:', config);
                
                const favorites = config.user_customization?.è‡ªå®šä¹‰ç›‘æ§?.è‡ªé€‰è‚¡ç¥¨æ±  || [];
                currentFavorites = favorites;
                
                document.getElementById('config-status').innerHTML = `
                    <div class="success">âœ… é…ç½®åŠ è½½æˆåŠŸ</div>
                    <div>è‡ªé€‰è‚¡æ•°é‡: ${favorites.length}</div>
                `;
                
                renderFavorites(favorites);
            } catch (error) {
                document.getElementById('config-status').innerHTML = `
                    <div class="error">âŒ é…ç½®åŠ è½½å¤±è´¥: ${error.message}</div>
                `;
            }
        }
        
        // æ¸²æŸ“è‡ªé€‰è‚¡åˆ—è¡¨
        function renderFavorites(favorites) {
            const container = document.getElementById('favorites-list');
            
            if (favorites.length === 0) {
                container.innerHTML = '<div class="info">ğŸ“ æš‚æ— è‡ªé€‰è‚¡</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="favorite-list">
                    ${favorites.map(code => `
                        <div class="favorite-item">
                            <span><strong>${code}</strong></span>
                            <button class="delete-btn" onclick="deleteFavorite('${code}')">
                                âœ• åˆ é™¤
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // æ·»åŠ è‡ªé€‰è‚¡
        async function addFavorite() {
            const input = document.getElementById('stock-input');
            const code = input.value.trim();
            
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            try {
                const newFavorites = [...currentFavorites, code];
                
                const response = await fetch('http://localhost:9000/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_customization: {
                            è‡ªå®šä¹‰ç›‘æ§: {
                                è‡ªé€‰è‚¡ç¥¨æ± : newFavorites
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    currentFavorites = newFavorites;
                    renderFavorites(newFavorites);
                    input.value = '';
                    logTest(`âœ… æ·»åŠ æˆåŠŸ: ${code}`);
                } else {
                    logTest(`âŒ æ·»åŠ å¤±è´¥: HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ é™¤è‡ªé€‰è‚¡
        async function deleteFavorite(code) {
            try {
                const newFavorites = currentFavorites.filter(c => c !== code);
                
                const response = await fetch('http://localhost:9000/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_customization: {
                            è‡ªå®šä¹‰ç›‘æ§: {
                                è‡ªé€‰è‚¡ç¥¨æ± : newFavorites
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    currentFavorites = newFavorites;
                    renderFavorites(newFavorites);
                    logTest(`âœ… åˆ é™¤æˆåŠŸ: ${code}`);
                } else {
                    logTest(`âŒ åˆ é™¤å¤±è´¥: HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // æµ‹è¯•å‡½æ•°
        async function testGetConfig() {
            logTest('ğŸ” æµ‹è¯•è·å–é…ç½®...');
            await loadConfig();
        }
        
        async function testAddFavorite() {
            logTest('ğŸ“ æµ‹è¯•æ·»åŠ è‡ªé€‰è‚¡...');
            const testCode = '000001';
            if (!currentFavorites.includes(testCode)) {
                document.getElementById('stock-input').value = testCode;
                await addFavorite();
            } else {
                logTest(`âš ï¸ ${testCode} å·²åœ¨è‡ªé€‰è‚¡ä¸­`);
            }
        }
        
        async function testDeleteFavorite() {
            logTest('ğŸ—‘ï¸ æµ‹è¯•åˆ é™¤è‡ªé€‰è‚¡...');
            if (currentFavorites.length > 0) {
                await deleteFavorite(currentFavorites[0]);
            } else {
                logTest('âš ï¸ æ²¡æœ‰è‡ªé€‰è‚¡å¯åˆ é™¤');
            }
        }
        
        function logTest(message) {
            const output = document.getElementById('test-output');
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // åˆå§‹åŒ–
        loadConfig();
    </script>
</body>
</html>

