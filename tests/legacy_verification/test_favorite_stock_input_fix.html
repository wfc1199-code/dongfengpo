<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªé€‰è‚¡è¾“å…¥æ¡†ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #e5e5e5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .test-section {
            border: 1px solid #444;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #1e1e1e;
        }
        .test-title {
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #2e7d32; color: white; }
        .error { background: #d32f2f; color: white; }
        .info { background: #1976d2; color: white; }
        .warning { background: #f57c00; color: white; }

        /* å¤åˆ¶StockListçš„ä¿®å¤æ ·å¼ */
        .add-stock-panel {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .search-input-wrapper {
            margin-bottom: 8px;
        }

        .add-stock-panel .search-input,
        .search-input {
            width: 100% !important;
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            color: #fff !important;
            font-size: 13px !important;
            outline: none !important;
            transition: border-color 0.2s ease;
            /* ç¡®ä¿è¾“å…¥æ¡†å¯ç”¨ */
            pointer-events: auto !important;
            cursor: text !important;
            opacity: 1 !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            /* è¦†ç›–å…¨å±€æ ·å¼ */
            box-sizing: border-box !important;
        }

        .add-stock-panel .search-input:focus,
        .search-input:focus {
            border-color: #4a9eff !important;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2) !important;
            background: #2a2a2a !important;
            color: #fff !important;
        }

        .add-stock-panel .search-input::placeholder,
        .search-input::placeholder {
            color: #888 !important;
        }

        .test-btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }

        .test-btn:hover {
            background: #357abd;
            transform: translateY(-1px);
        }

        .input-test-result {
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            font-family: monospace;
        }

        .favorites-list {
            background: #333;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #444;
        }

        .delete-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ è‡ªé€‰è‚¡è¾“å…¥æ¡†ä¿®å¤æµ‹è¯•</h1>

        <div class="test-section">
            <div class="test-title">1. CSSæ ·å¼ä¿®å¤éªŒè¯</div>
            <div class="info">æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦åº”ç”¨äº†æ­£ç¡®çš„æ ·å¼ä¿®å¤</div>

            <div class="add-stock-panel">
                <div class="search-input-wrapper">
                    <input
                        type="text"
                        placeholder="æµ‹è¯•è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: 000001)"
                        class="search-input"
                        id="test-input-1"
                    />
                </div>
                <div class="input-test-result" id="input-status-1">
                    è¾“å…¥æ¡†çŠ¶æ€ï¼šç­‰å¾…æµ‹è¯•...
                </div>
            </div>

            <button class="test-btn" onclick="testInputFunctionality()">æµ‹è¯•è¾“å…¥åŠŸèƒ½</button>
            <button class="test-btn" onclick="testInputStyles()">æ£€æŸ¥æ ·å¼</button>
        </div>

        <div class="test-section">
            <div class="test-title">2. å®é™…æ·»åŠ è‡ªé€‰è‚¡æµ‹è¯•</div>
            <div class="info">æµ‹è¯•ä¸åç«¯APIçš„å®Œæ•´äº¤äº’</div>

            <div class="add-stock-panel">
                <div class="search-input-wrapper">
                    <input
                        type="text"
                        placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æ·»åŠ åˆ°è‡ªé€‰è‚¡"
                        class="search-input"
                        id="stock-code-input"
                        onkeypress="handleEnterKey(event)"
                    />
                </div>
                <button class="test-btn" onclick="addToFavorites()">æ·»åŠ åˆ°è‡ªé€‰è‚¡</button>
                <button class="test-btn" onclick="loadFavorites()">åˆ·æ–°è‡ªé€‰è‚¡åˆ—è¡¨</button>
            </div>

            <div id="favorites-display" class="favorites-list">
                <div class="info">ç‚¹å‡»"åˆ·æ–°è‡ªé€‰è‚¡åˆ—è¡¨"åŠ è½½å½“å‰è‡ªé€‰è‚¡</div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">3. APIè¿æ¥æµ‹è¯•</div>
            <div id="api-test-results">
                <button class="test-btn" onclick="testConfigAPI()">æµ‹è¯•é…ç½®API</button>
                <button class="test-btn" onclick="testStockSearchAPI()">æµ‹è¯•è‚¡ç¥¨æœç´¢API</button>
            </div>
            <div id="api-results" class="input-test-result">
                APIæµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            </div>
        </div>
    </div>

    <script>
        let currentFavorites = [];

        function testInputFunctionality() {
            const input = document.getElementById('test-input-1');
            const status = document.getElementById('input-status-1');

            // æµ‹è¯•å„ç§è¾“å…¥æ“ä½œ
            const tests = [
                { name: 'èšç„¦æµ‹è¯•', action: () => input.focus() },
                { name: 'è¾“å…¥æµ‹è¯•', action: () => { input.value = 'TEST123'; input.dispatchEvent(new Event('input')); } },
                { name: 'é€‰æ‹©æµ‹è¯•', action: () => input.select() },
                { name: 'æ¸…ç©ºæµ‹è¯•', action: () => { input.value = ''; input.dispatchEvent(new Event('input')); } }
            ];

            let results = [];
            tests.forEach(test => {
                try {
                    test.action();
                    results.push(`âœ… ${test.name}: æˆåŠŸ`);
                } catch (error) {
                    results.push(`âŒ ${test.name}: å¤±è´¥ - ${error.message}`);
                }
            });

            status.innerHTML = `
                <strong>è¾“å…¥åŠŸèƒ½æµ‹è¯•ç»“æœï¼š</strong><br>
                ${results.join('<br>')}
                <br><br>
                <strong>è¾“å…¥æ¡†å±æ€§ï¼š</strong><br>
                disabled: ${input.disabled}<br>
                readOnly: ${input.readOnly}<br>
                style.pointerEvents: ${getComputedStyle(input).pointerEvents}<br>
                style.cursor: ${getComputedStyle(input).cursor}<br>
                style.opacity: ${getComputedStyle(input).opacity}
            `;
        }

        function testInputStyles() {
            const input = document.getElementById('test-input-1');
            const styles = getComputedStyle(input);
            const status = document.getElementById('input-status-1');

            status.innerHTML = `
                <strong>è®¡ç®—æ ·å¼æ£€æŸ¥ï¼š</strong><br>
                background-color: ${styles.backgroundColor}<br>
                color: ${styles.color}<br>
                border: ${styles.border}<br>
                padding: ${styles.padding}<br>
                pointer-events: ${styles.pointerEvents}<br>
                cursor: ${styles.cursor}<br>
                opacity: ${styles.opacity}<br>
                user-select: ${styles.userSelect}<br>
                box-sizing: ${styles.boxSizing}
            `;
        }

        async function loadFavorites() {
            try {
                const response = await fetch('http://localhost:9000/api/config');
                const config = await response.json();

                const favorites = config.user_customization?.è‡ªå®šä¹‰ç›‘æ§?.è‡ªé€‰è‚¡ç¥¨æ±  || [];
                currentFavorites = favorites;

                renderFavorites(favorites);
            } catch (error) {
                document.getElementById('favorites-display').innerHTML = `
                    <div class="error">âŒ åŠ è½½è‡ªé€‰è‚¡å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        function renderFavorites(favorites) {
            const container = document.getElementById('favorites-display');

            if (favorites.length === 0) {
                container.innerHTML = '<div class="info">ğŸ“ æš‚æ— è‡ªé€‰è‚¡</div>';
                return;
            }

            container.innerHTML = `
                <div><strong>å½“å‰è‡ªé€‰è‚¡ (${favorites.length}åª)ï¼š</strong></div>
                ${favorites.map(code => `
                    <div class="favorite-item">
                        <span><strong>${code}</strong></span>
                        <button class="delete-btn" onclick="removeFromFavorites('${code}')">
                            âœ• åˆ é™¤
                        </button>
                    </div>
                `).join('')}
            `;
        }

        async function addToFavorites() {
            const input = document.getElementById('stock-code-input');
            const code = input.value.trim().toUpperCase();

            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            if (currentFavorites.includes(code)) {
                alert('è¯¥è‚¡ç¥¨å·²åœ¨è‡ªé€‰è‚¡ä¸­');
                return;
            }

            try {
                const newFavorites = [...currentFavorites, code];

                const response = await fetch('http://localhost:9000/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_customization: {
                            è‡ªå®šä¹‰ç›‘æ§: {
                                è‡ªé€‰è‚¡ç¥¨æ± : newFavorites
                            }
                        }
                    })
                });

                if (response.ok) {
                    currentFavorites = newFavorites;
                    renderFavorites(newFavorites);
                    input.value = '';

                    // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                    const originalPlaceholder = input.placeholder;
                    input.placeholder = `âœ… å·²æ·»åŠ  ${code}`;
                    setTimeout(() => {
                        input.placeholder = originalPlaceholder;
                    }, 2000);
                } else {
                    alert(`æ·»åŠ å¤±è´¥: HTTP ${response.status}`);
                }
            } catch (error) {
                alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        }

        async function removeFromFavorites(code) {
            try {
                const newFavorites = currentFavorites.filter(c => c !== code);

                const response = await fetch('http://localhost:9000/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_customization: {
                            è‡ªå®šä¹‰ç›‘æ§: {
                                è‡ªé€‰è‚¡ç¥¨æ± : newFavorites
                            }
                        }
                    })
                });

                if (response.ok) {
                    currentFavorites = newFavorites;
                    renderFavorites(newFavorites);
                } else {
                    alert(`åˆ é™¤å¤±è´¥: HTTP ${response.status}`);
                }
            } catch (error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                addToFavorites();
            }
        }

        async function testConfigAPI() {
            const results = document.getElementById('api-results');
            results.innerHTML = 'ğŸ” æµ‹è¯•é…ç½®API...';

            try {
                const response = await fetch('http://localhost:9000/api/config');
                const data = await response.json();

                results.innerHTML = `
                    <strong>âœ… é…ç½®APIæµ‹è¯•æˆåŠŸ</strong><br>
                    çŠ¶æ€ç : ${response.status}<br>
                    å“åº”å¤§å°: ${JSON.stringify(data).length} å­—ç¬¦<br>
                    è‡ªé€‰è‚¡æ•°é‡: ${data.user_customization?.è‡ªå®šä¹‰ç›‘æ§?.è‡ªé€‰è‚¡ç¥¨æ± ?.length || 0}
                `;
            } catch (error) {
                results.innerHTML = `
                    <strong>âŒ é…ç½®APIæµ‹è¯•å¤±è´¥</strong><br>
                    é”™è¯¯: ${error.message}
                `;
            }
        }

        async function testStockSearchAPI() {
            const results = document.getElementById('api-results');
            results.innerHTML = 'ğŸ” æµ‹è¯•è‚¡ç¥¨æœç´¢API...';

            try {
                const response = await fetch('http://localhost:9000/api/stocks/search?q=000001&limit=5');
                const data = await response.json();

                results.innerHTML = `
                    <strong>âœ… è‚¡ç¥¨æœç´¢APIæµ‹è¯•æˆåŠŸ</strong><br>
                    çŠ¶æ€ç : ${response.status}<br>
                    æœç´¢ç»“æœ: ${data.stocks?.length || 0} åªè‚¡ç¥¨<br>
                    ç¤ºä¾‹ç»“æœ: ${data.stocks?.[0]?.name || 'æ— '}
                `;
            } catch (error) {
                results.innerHTML = `
                    <strong>âŒ è‚¡ç¥¨æœç´¢APIæµ‹è¯•å¤±è´¥</strong><br>
                    é”™è¯¯: ${error.message}
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            loadFavorites();
        });
    </script>
</body>
</html>