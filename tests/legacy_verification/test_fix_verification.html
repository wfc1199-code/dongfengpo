<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>验证0轴修复 - 688155</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; margin: 0; padding: 20px; font-family: Arial; }
        #info { margin-bottom: 20px; padding: 15px; background: #333; border-radius: 5px; }
        .correct { color: #4CAF50; font-weight: bold; }
        .wrong { color: #FF4444; font-weight: bold; }
    </style>
</head>
<body>
    <div id="info">
        <h3>修复验证：</h3>
        <p>✅ 昨收价应该是: <span class="correct">53.31</span></p>
        <p>✅ 0轴应该显示在: <span class="correct">53.31</span> 的位置</p>
        <p>❌ 之前错误显示在: <span class="wrong">12.47</span> 的位置</p>
    </div>
    <div id="chart" style="width: 100%; height: 500px;"></div>
    
    <script>
        async function verify() {
            const response = await fetch('http://localhost:9000/api/stocks/688155/timeshare');
            const data = await response.json();
            
            const yesterdayClose = data.yesterday_close || 53.31;
            const timeshareData = data.timeshare_data || [];
            
            console.log('API返回的昨收价:', yesterdayClose);
            console.log('应该使用的昨收价: 53.31');
            
            // 提取数据
            const times = [];
            const prices = [];
            timeshareData.forEach(item => {
                times.push(item.time);
                prices.push(item.price);
            });
            
            // 计算Y轴范围（使用修复后的逻辑）
            const validPrices = prices.filter(p => p > 0);
            const finalYesterdayClose = yesterdayClose || 53.31;
            
            let yAxisMax = finalYesterdayClose * 1.1;
            let yAxisMin = finalYesterdayClose * 0.9;
            
            if (validPrices.length > 0) {
                const maxPrice = Math.max(...validPrices);
                const minPrice = Math.min(...validPrices);
                const adjustedMax = Math.max(maxPrice, finalYesterdayClose);
                const adjustedMin = Math.min(minPrice, finalYesterdayClose);
                const priceRange = adjustedMax - adjustedMin;
                yAxisMax = adjustedMax + priceRange * 0.1;
                yAxisMin = adjustedMin - priceRange * 0.1;
            }
            
            console.log('Y轴范围:', yAxisMin.toFixed(2), '-', yAxisMax.toFixed(2));
            console.log('0轴位置:', finalYesterdayClose);
            
            // 创建图表
            const chart = echarts.init(document.getElementById('chart'));
            const option = {
                title: {
                    text: '修复后的分时图 - 0轴应该在53.31',
                    textStyle: { color: '#fff' }
                },
                backgroundColor: '#1a1a1a',
                grid: {
                    left: 80,
                    right: 80,
                    top: 60,
                    bottom: 80
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#999', interval: 30 }
                },
                yAxis: [
                    {
                        type: 'value',
                        position: 'left',
                        min: yAxisMin,
                        max: yAxisMax,
                        axisLine: { lineStyle: { color: '#555' } },
                        axisLabel: {
                            color: '#999',
                            formatter: v => v.toFixed(2)
                        },
                        splitLine: {
                            lineStyle: { color: '#333', type: 'dashed' }
                        }
                    },
                    {
                        type: 'value',
                        position: 'right',
                        min: yAxisMin,
                        max: yAxisMax,
                        axisLabel: {
                            color: '#999',
                            formatter: v => {
                                const pct = ((v - finalYesterdayClose) / finalYesterdayClose * 100);
                                return `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
                            }
                        }
                    }
                ],
                series: [{
                    type: 'line',
                    data: prices,
                    smooth: false,
                    symbol: 'none',
                    lineStyle: { color: '#00bfff', width: 2 },
                    markLine: {
                        data: [{
                            yAxis: finalYesterdayClose,
                            lineStyle: {
                                color: '#ffffff',
                                type: 'dashed',
                                width: 2
                            },
                            label: {
                                formatter: `昨收 ${finalYesterdayClose.toFixed(2)}`,
                                position: 'end',
                                color: '#ffffff',
                                backgroundColor: 'rgba(0,0,0,0.7)',
                                padding: [4, 8]
                            }
                        }]
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        verify();
    </script>
</body>
</html>