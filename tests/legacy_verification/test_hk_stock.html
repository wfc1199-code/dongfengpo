<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>港股测试 - 晶泰控股(02228)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section h2 { margin-top: 0; color: #333; }
        .data-item { margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>港股支持测试 - 晶泰控股(02228)</h1>
        
        <div class="section">
            <h2>1. 搜索测试</h2>
            <button onclick="testSearch('02228')">搜索代码: 02228</button>
            <button onclick="testSearch('晶泰')">搜索名称: 晶泰</button>
            <div id="searchResult"></div>
        </div>
        
        <div class="section">
            <h2>2. 实时数据测试</h2>
            <button onclick="testRealtime('02228')">获取实时数据</button>
            <div id="realtimeResult"></div>
        </div>
        
        <div class="section">
            <h2>3. K线数据测试</h2>
            <button onclick="testKline('02228', 'daily')">日K线</button>
            <button onclick="testKline('02228', '5m')">5分钟K线</button>
            <button onclick="testKline('02228', '15m')">15分钟K线</button>
            <div id="klineResult"></div>
        </div>
        
        <div class="section">
            <h2>4. 自选股测试</h2>
            <button onclick="addToFavorites('02228')">添加到自选股</button>
            <button onclick="getFavorites()">查看自选股列表</button>
            <div id="favoritesResult"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:9000/api';
        
        async function testSearch(query) {
            const resultDiv = document.getElementById('searchResult');
            try {
                const response = await fetch(`${API_BASE}/stocks/search?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                
                let html = `<h3>搜索 "${query}" 结果:</h3>`;
                if (data.stocks && data.stocks.length > 0) {
                    html += '<ul>';
                    data.stocks.forEach(stock => {
                        const isHK = stock.market === 'HK';
                        html += `<li class="${isHK ? 'success' : ''}">${stock.code} - ${stock.name} (${stock.market}) ${isHK ? '✅ 港股' : ''}</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p class="error">未找到结果</p>';
                }
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }
        
        async function testRealtime(code) {
            const resultDiv = document.getElementById('realtimeResult');
            try {
                const response = await fetch(`${API_BASE}/stocks/${code}/realtime`);
                const data = await response.json();
                
                let html = '<h3>实时数据:</h3>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                if (data.code && data.code.startsWith('hk')) {
                    html += '<p class="success">✅ 正确识别为港股 (代码前缀: hk)</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }
        
        async function testKline(code, period) {
            const resultDiv = document.getElementById('klineResult');
            try {
                const response = await fetch(`${API_BASE}/stocks/${code}/kline?period=${period}&count=10`);
                const data = await response.json();
                
                let html = `<h3>${period === 'daily' ? '日' : period} K线数据:</h3>`;
                html += `<p>股票名称: ${data.name || 'N/A'}</p>`;
                html += `<p>股票代码: ${data.code || 'N/A'}</p>`;
                html += `<p>昨收价: ${data.yesterday_close || 'N/A'}</p>`;
                html += `<p>K线数量: ${data.klines ? data.klines.length : 0}</p>`;
                
                if (data.klines && data.klines.length > 0) {
                    html += '<p>最新K线:</p>';
                    html += '<pre>' + JSON.stringify(data.klines[data.klines.length - 1], null, 2) + '</pre>';
                    html += '<p class="success">✅ K线数据获取成功</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }
        
        async function addToFavorites(code) {
            const resultDiv = document.getElementById('favoritesResult');
            try {
                // 先获取当前配置
                const configResponse = await fetch(`${API_BASE}/config`);
                const config = await configResponse.json();
                
                const currentFavorites = config?.user_customization?.自定义监控?.自选股票池 || [];
                
                if (currentFavorites.includes(code)) {
                    resultDiv.innerHTML = `<p>股票 ${code} 已在自选股中</p>`;
                    return;
                }
                
                // 添加到自选股
                const newFavorites = [...currentFavorites, code];
                
                const response = await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_customization: {
                            自定义监控: {
                                自选股票池: newFavorites
                            }
                        }
                    }),
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = `<p class="success">✅ 成功添加 ${code} 到自选股</p>`;
                    getFavorites();
                } else {
                    resultDiv.innerHTML = `<p class="error">添加失败</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }
        
        async function getFavorites() {
            const resultDiv = document.getElementById('favoritesResult');
            try {
                const response = await fetch(`${API_BASE}/config`);
                const config = await response.json();
                
                const favorites = config?.user_customization?.自定义监控?.自选股票池 || [];
                
                let html = '<h3>当前自选股列表:</h3>';
                if (favorites.length > 0) {
                    html += '<ul>';
                    for (const code of favorites) {
                        const isHK = code.length === 5 && /^\d+$/.test(code);
                        html += `<li class="${isHK ? 'success' : ''}">${code} ${isHK ? '✅ 港股' : ''}</li>`;
                    }
                    html += '</ul>';
                } else {
                    html += '<p>自选股列表为空</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }
        
        // 页面加载时自动获取自选股列表
        window.onload = () => {
            getFavorites();
        };
    </script>
</body>
</html>