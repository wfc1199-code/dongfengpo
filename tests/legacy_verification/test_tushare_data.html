<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tushare真实数据测试</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .controls button:active {
            transform: translateY(0);
        }
        
        .controls input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 150px;
        }
        
        .status {
            flex: 1;
            text-align: right;
            font-size: 14px;
            color: #666;
        }
        
        .status.loading {
            color: #667eea;
        }
        
        .status.success {
            color: #10b981;
        }
        
        .status.error {
            color: #ef4444;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card .badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .stock-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .stock-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .stock-item:hover {
            background: #f8f9fa;
        }
        
        .stock-item:last-child {
            border-bottom: none;
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-code {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .stock-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-stats {
            text-align: right;
        }
        
        .stock-price {
            font-size: 18px;
            font-weight: bold;
            color: #ef4444;
            margin-bottom: 4px;
        }
        
        .stock-meta {
            font-size: 12px;
            color: #999;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart {
            width: 100%;
            height: 400px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .limit-times {
            display: inline-block;
            background: #fef3c7;
            color: #d97706;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .industry-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .dragon-tiger-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .dragon-tiger-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .dragon-tiger-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 12px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #999;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .buy-value {
            color: #ef4444;
        }
        
        .sell-value {
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tushare Pro - 真实Level2数据</h1>
            <p>实时涨停板监控 | 龙虎榜追踪 | 市场异动分析</p>
        </div>
        
        <div class="controls">
            <button onclick="loadTodayLimitUp()">今日涨停板</button>
            <button onclick="loadDragonTiger()">龙虎榜数据</button>
            <button onclick="loadRealtimeQuotes()">实时行情</button>
            <input type="text" id="dateInput" placeholder="日期 YYYYMMDD">
            <button onclick="loadHistoryData()">查询历史</button>
            <div class="status" id="status">就绪</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('limitup')">涨停板分析</div>
            <div class="tab" onclick="switchTab('dragon')">龙虎榜追踪</div>
            <div class="tab" onclick="switchTab('realtime')">实时监控</div>
            <div class="tab" onclick="switchTab('analysis')">数据分析</div>
        </div>
        
        <div id="limitup-content">
            <div class="grid">
                <div class="card">
                    <h2>
                        首板涨停
                        <span class="badge" id="firstLimitCount">0</span>
                    </h2>
                    <div class="stock-list" id="firstLimitList"></div>
                </div>
                
                <div class="card">
                    <h2>
                        连板股票
                        <span class="badge" id="continuousLimitCount">0</span>
                    </h2>
                    <div class="stock-list" id="continuousLimitList"></div>
                </div>
                
                <div class="card">
                    <h2>
                        强势封板
                        <span class="badge" id="strongLimitCount">0</span>
                    </h2>
                    <div class="stock-list" id="strongLimitList"></div>
                </div>
                
                <div class="card">
                    <h2>
                        新股涨停
                        <span class="badge" id="newStockCount">0</span>
                    </h2>
                    <div class="stock-list" id="newStockList"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>涨停板行业分布</h2>
                <div id="industryChart" class="chart"></div>
            </div>
        </div>
        
        <div id="dragon-content" style="display: none;">
            <div class="card">
                <h2>龙虎榜数据</h2>
                <div id="dragonTigerList"></div>
            </div>
            
            <div class="chart-container">
                <h2>龙虎榜资金流向</h2>
                <div id="moneyFlowChart" class="chart"></div>
            </div>
        </div>
        
        <div id="realtime-content" style="display: none;">
            <div class="card">
                <h2>实时行情监控</h2>
                <div id="realtimeList"></div>
            </div>
            
            <div class="chart-container">
                <h2>分时走势</h2>
                <div id="minuteChart" class="chart"></div>
            </div>
        </div>
        
        <div id="analysis-content" style="display: none;">
            <div class="grid">
                <div class="chart-container">
                    <h2>涨停时间分布</h2>
                    <div id="timeChart" class="chart"></div>
                </div>
                
                <div class="chart-container">
                    <h2>连板梯队分析</h2>
                    <div id="ladderChart" class="chart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:9000/api/tushare';
        let currentTab = 'limitup';
        let limitUpData = null;
        let dragonTigerData = null;
        
        // 切换标签页
        function switchTab(tab) {
            currentTab = tab;
            
            // 更新标签样式
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // 显示对应内容
            document.getElementById('limitup-content').style.display = tab === 'limitup' ? 'block' : 'none';
            document.getElementById('dragon-content').style.display = tab === 'dragon' ? 'block' : 'none';
            document.getElementById('realtime-content').style.display = tab === 'realtime' ? 'block' : 'none';
            document.getElementById('analysis-content').style.display = tab === 'analysis' ? 'block' : 'none';
        }
        
        // 更新状态
        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // 加载今日涨停板数据
        async function loadTodayLimitUp() {
            try {
                updateStatus('正在加载涨停板数据...', 'loading');
                
                const response = await fetch(`${API_BASE}/limit-up/today`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                limitUpData = await response.json();
                
                // 更新统计
                document.getElementById('firstLimitCount').textContent = limitUpData.first_limit.length;
                document.getElementById('continuousLimitCount').textContent = limitUpData.continuous_limit.length;
                document.getElementById('strongLimitCount').textContent = limitUpData.strong_stocks.length;
                document.getElementById('newStockCount').textContent = limitUpData.new_stocks.length;
                
                // 渲染列表
                renderStockList('firstLimitList', limitUpData.first_limit);
                renderStockList('continuousLimitList', limitUpData.continuous_limit);
                renderStockList('strongLimitList', limitUpData.strong_stocks);
                renderStockList('newStockList', limitUpData.new_stocks);
                
                // 渲染图表
                renderIndustryChart(limitUpData.data);
                renderTimeChart(limitUpData.data);
                renderLadderChart(limitUpData.data);
                
                updateStatus(`加载完成：${limitUpData.total}只涨停股票`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('加载失败：' + error.message, 'error');
            }
        }
        
        // 加载龙虎榜数据
        async function loadDragonTiger() {
            try {
                updateStatus('正在加载龙虎榜数据...', 'loading');
                
                const response = await fetch(`${API_BASE}/top-list/today`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                dragonTigerData = await response.json();
                
                renderDragonTigerList(dragonTigerData.data);
                renderMoneyFlowChart(dragonTigerData.data);
                
                updateStatus(`加载完成：${dragonTigerData.total}条龙虎榜数据`, 'success');
                
                // 切换到龙虎榜标签
                document.querySelector('.tab:nth-child(2)').click();
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('加载失败：' + error.message, 'error');
            }
        }
        
        // 加载实时行情
        async function loadRealtimeQuotes() {
            try {
                if (!limitUpData || !limitUpData.data.length) {
                    updateStatus('请先加载涨停板数据', 'error');
                    return;
                }
                
                updateStatus('正在加载实时行情...', 'loading');
                
                // 获取前10只涨停股的实时行情
                const codes = limitUpData.data.slice(0, 10).map(s => s.ts_code).join(',');
                const response = await fetch(`${API_BASE}/realtime/batch?ts_codes=${codes}`);
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const realtimeData = await response.json();
                
                renderRealtimeList(realtimeData);
                
                updateStatus('实时行情加载完成', 'success');
                
                // 切换到实时监控标签
                document.querySelector('.tab:nth-child(3)').click();
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('加载失败：' + error.message, 'error');
            }
        }
        
        // 渲染股票列表
        function renderStockList(elementId, stocks) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            stocks.slice(0, 10).forEach(stock => {
                const item = document.createElement('div');
                item.className = 'stock-item';
                item.innerHTML = `
                    <div class="stock-info">
                        <div class="stock-code">${stock.ts_code}</div>
                        <div class="stock-name">
                            ${stock.name}
                            ${stock.limit_times > 1 ? `<span class="limit-times">${stock.limit_times}连板</span>` : ''}
                        </div>
                        ${stock.industry ? `<span class="industry-tag">${stock.industry}</span>` : ''}
                    </div>
                    <div class="stock-stats">
                        <div class="stock-price">+${stock.pct_chg.toFixed(2)}%</div>
                        <div class="stock-meta">成交${(stock.amount/100000000).toFixed(2)}亿</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // 渲染龙虎榜列表
        function renderDragonTigerList(data) {
            const container = document.getElementById('dragonTigerList');
            container.innerHTML = '';
            
            data.slice(0, 20).forEach(item => {
                const div = document.createElement('div');
                div.className = 'dragon-tiger-item';
                div.innerHTML = `
                    <div class="dragon-tiger-header">
                        <div>
                            <strong>${item.ts_code} ${item.name}</strong>
                            <span style="margin-left: 10px; color: ${item.pct_change > 0 ? '#ef4444' : '#10b981'}">
                                ${item.pct_change > 0 ? '+' : ''}${item.pct_change.toFixed(2)}%
                            </span>
                        </div>
                        <div>${item.reason}</div>
                    </div>
                    <div class="dragon-tiger-stats">
                        <div class="stat-item">
                            <div class="stat-label">买入金额</div>
                            <div class="stat-value buy-value">${(item.l_buy/10000).toFixed(0)}万</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">卖出金额</div>
                            <div class="stat-value sell-value">${(item.l_sell/10000).toFixed(0)}万</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">净买入</div>
                            <div class="stat-value" style="color: ${item.net_amount > 0 ? '#ef4444' : '#10b981'}">
                                ${(item.net_amount/10000).toFixed(0)}万
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // 渲染实时行情列表
        function renderRealtimeList(data) {
            const container = document.getElementById('realtimeList');
            container.innerHTML = '';
            
            Object.entries(data).forEach(([code, info]) => {
                const pctChg = info.pct_chg || 0;
                const div = document.createElement('div');
                div.className = 'stock-item';
                div.innerHTML = `
                    <div class="stock-info">
                        <div class="stock-code">${code}</div>
                        <div class="stock-name">${info.name}</div>
                        <div class="stock-meta">最新时间：${info.time}</div>
                    </div>
                    <div class="stock-stats">
                        <div class="stock-price" style="color: ${pctChg > 0 ? '#ef4444' : '#10b981'}">
                            ¥${info.price.toFixed(2)}
                        </div>
                        <div class="stock-meta">
                            ${pctChg > 0 ? '+' : ''}${pctChg.toFixed(2)}%
                        </div>
                        <div class="stock-meta" style="margin-top: 4px;">
                            成交${(info.amount/100000000).toFixed(2)}亿
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // 渲染行业分布图
        function renderIndustryChart(data) {
            const chart = echarts.init(document.getElementById('industryChart'));
            
            // 统计行业分布
            const industryMap = {};
            data.forEach(stock => {
                const industry = stock.industry || '其他';
                industryMap[industry] = (industryMap[industry] || 0) + 1;
            });
            
            const sortedIndustries = Object.entries(industryMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: sortedIndustries.map(item => item[0])
                },
                series: [{
                    name: '涨停数量',
                    type: 'bar',
                    data: sortedIndustries.map(item => item[1]),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // 渲染涨停时间分布图
        function renderTimeChart(data) {
            const chart = echarts.init(document.getElementById('timeChart'));
            
            // 统计涨停时间分布
            const timeMap = {
                '09:30-10:00': 0,
                '10:00-10:30': 0,
                '10:30-11:00': 0,
                '11:00-11:30': 0,
                '13:00-13:30': 0,
                '13:30-14:00': 0,
                '14:00-14:30': 0,
                '14:30-15:00': 0
            };
            
            data.forEach(stock => {
                const time = stock.first_limit_time;
                if (time) {
                    const hour = parseInt(time.split(':')[0]);
                    const minute = parseInt(time.split(':')[1]);
                    
                    if (hour === 9 && minute >= 30) timeMap['09:30-10:00']++;
                    else if (hour === 10 && minute < 30) timeMap['10:00-10:30']++;
                    else if (hour === 10 && minute >= 30) timeMap['10:30-11:00']++;
                    else if (hour === 11 && minute < 30) timeMap['11:00-11:30']++;
                    else if (hour === 13 && minute < 30) timeMap['13:00-13:30']++;
                    else if (hour === 13 && minute >= 30) timeMap['13:30-14:00']++;
                    else if (hour === 14 && minute < 30) timeMap['14:00-14:30']++;
                    else if (hour === 14 && minute >= 30) timeMap['14:30-15:00']++;
                }
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(timeMap)
                },
                yAxis: {
                    type: 'value',
                    name: '涨停数量'
                },
                series: [{
                    data: Object.values(timeMap),
                    type: 'line',
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(102, 126, 234, 0.5)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#667eea',
                        width: 2
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // 渲染连板梯队图
        function renderLadderChart(data) {
            const chart = echarts.init(document.getElementById('ladderChart'));
            
            // 统计连板梯队
            const ladderMap = {};
            data.forEach(stock => {
                const times = stock.limit_times || 1;
                const key = times === 1 ? '首板' : `${times}连板`;
                ladderMap[key] = (ladderMap[key] || 0) + 1;
            });
            
            const option = {
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    name: '连板梯队',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}只\n({d}%)'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 20,
                            fontWeight: 'bold'
                        }
                    },
                    data: Object.entries(ladderMap).map(([name, value]) => ({
                        name,
                        value,
                        itemStyle: {
                            color: name === '首板' ? '#667eea' :
                                  name.includes('2') ? '#764ba2' :
                                  name.includes('3') ? '#ef4444' :
                                  name.includes('4') ? '#f59e0b' :
                                  '#10b981'
                        }
                    }))
                }]
            };
            
            chart.setOption(option);
        }
        
        // 渲染资金流向图
        function renderMoneyFlowChart(data) {
            const chart = echarts.init(document.getElementById('moneyFlowChart'));
            
            // 取前10只股票的资金流向
            const topStocks = data.slice(0, 10);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['买入', '卖出', '净买入']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: topStocks.map(s => s.name),
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '金额(万元)'
                },
                series: [
                    {
                        name: '买入',
                        type: 'bar',
                        data: topStocks.map(s => (s.l_buy/10000).toFixed(0)),
                        itemStyle: { color: '#ef4444' }
                    },
                    {
                        name: '卖出',
                        type: 'bar',
                        data: topStocks.map(s => -(s.l_sell/10000).toFixed(0)),
                        itemStyle: { color: '#10b981' }
                    },
                    {
                        name: '净买入',
                        type: 'line',
                        data: topStocks.map(s => (s.net_amount/10000).toFixed(0)),
                        itemStyle: { color: '#667eea' }
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // 页面加载完成后自动加载今日涨停板
        window.onload = function() {
            loadTodayLimitUp();
        };
        
        // 响应式图表
        window.addEventListener('resize', function() {
            const charts = ['industryChart', 'timeChart', 'ladderChart', 'moneyFlowChart', 'minuteChart'];
            charts.forEach(id => {
                const chartDom = document.getElementById(id);
                if (chartDom && echarts.getInstanceByDom(chartDom)) {
                    echarts.getInstanceByDom(chartDom).resize();
                }
            });
        });
    </script>
</body>
</html>