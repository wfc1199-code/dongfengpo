<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´åˆ†å±‚ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px;
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .api-data { 
            background: #e8f5e8; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .time-distribution { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin: 20px 0;
        }
        .time-slot { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }
        .slot-header { 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: #333;
        }
        .stock-item { 
            padding: 8px; 
            margin: 5px 0; 
            background: #f0f8ff; 
            border-radius: 4px;
            font-size: 12px;
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .btn:hover { 
            background: #0056b3; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .loading { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ—¶é—´åˆ†å±‚æ¶¨åœé¢„æµ‹ - ä¿®å¤éªŒè¯</h1>
            <p>éªŒè¯ä¿®å¤åçš„æ•°æ®å‡†ç¡®æ€§å’Œæ—¶é—´åˆ†å±‚é€»è¾‘</p>
        </div>

        <div class="test-section">
            <h3>ğŸ” APIæ•°æ®æµ‹è¯•</h3>
            <button class="btn" onclick="testApiData()">æµ‹è¯•APIæ•°æ®</button>
            <button class="btn" onclick="testTimeDistribution()">æµ‹è¯•æ—¶é—´åˆ†å±‚</button>
            <button class="btn" onclick="openMainPage()">æ‰“å¼€ä¸»é¡µé¢</button>
            <div id="apiStatus" class="status loading">ç­‰å¾…æµ‹è¯•...</div>
            <div id="apiData" class="api-data" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>â° æ—¶é—´åˆ†å±‚ç»“æœ</h3>
            <div id="timeDistribution" class="time-distribution">
                <!-- æ—¶é—´åˆ†å±‚ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ æ•°æ®è´¨é‡éªŒè¯</h3>
            <div id="dataQuality">
                <!-- æ•°æ®è´¨é‡æŠ¥å‘Šå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // æ—¶é—´æ®µå®šä¹‰
        const timeSlots = [
            { start: '09:30', end: '09:45', label: 'ğŸš€ å¼€ç›˜å†²åˆº' },
            { start: '09:45', end: '10:00', label: 'ğŸ¯ è¶‹åŠ¿ç¡®è®¤' },
            { start: '10:00', end: '10:30', label: 'â­ é»„é‡‘å†³ç­–' },
            { start: '10:30', end: '11:00', label: 'ğŸ“ˆ å¼ºåŠ¿å»¶ç»­' },
            { start: '11:00', end: '11:30', label: 'ğŸ” åˆå‰è§‚å¯Ÿ' },
            { start: '13:00', end: '14:00', label: 'ğŸŒŸ åˆåå‘åŠ›' },
            { start: '14:00', end: '14:30', label: 'ğŸ’ª å°¾ç›˜å†²åˆº' },
            { start: '14:30', end: '15:00', label: 'ğŸ¨ å°æ¿å†³æˆ˜' }
        ];

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function isTimeInSlot(time, slot) {
            if (!time) return false;
            const timeMinutes = timeToMinutes(time);
            const startMinutes = timeToMinutes(slot.start);
            const endMinutes = timeToMinutes(slot.end);
            return timeMinutes >= startMinutes && timeMinutes < endMinutes;
        }

        async function testApiData() {
            const statusDiv = document.getElementById('apiStatus');
            const dataDiv = document.getElementById('apiData');
            
            try {
                statusDiv.className = 'status loading';
                statusDiv.textContent = 'ğŸ”„ æ­£åœ¨è·å–APIæ•°æ®...';
                
                const response = await fetch('http://localhost:9000/api/limit-up-tracker/today?refresh=true');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.predictions) {
                    const predictions = data.data.predictions;
                    
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… æˆåŠŸè·å– ${predictions.length} åªè‚¡ç¥¨æ•°æ®`;
                    
                    // æ˜¾ç¤ºå‰5åªè‚¡ç¥¨çš„è¯¦ç»†æ•°æ®
                    let apiDataHtml = '<h4>å‰5åªè‚¡ç¥¨æ•°æ®æ ·æœ¬:</h4>';
                    predictions.slice(0, 5).forEach((stock, index) => {
                        apiDataHtml += `
                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong>${index + 1}. ${stock.name} (${stock.code})</strong><br>
                                é€‰å‡ºæ—¶é—´: ${stock.sealTime || 'N/A'}<br>
                                æ¶¨å¹…: ${stock.changePercent || 0}%<br>
                                æˆäº¤é¢: ${((stock.amount || 0) / 10000).toFixed(1)}äº¿<br>
                                æ¢æ‰‹ç‡: ${stock.turnoverRate || 0}%<br>
                                é¢„æµ‹åˆ†æ•°: ${stock.predictionScore || 0}åˆ†
                            </div>
                        `;
                    });
                    
                    dataDiv.innerHTML = apiDataHtml;
                    dataDiv.style.display = 'block';
                    
                    // å­˜å‚¨æ•°æ®ä¾›å…¶ä»–æµ‹è¯•ä½¿ç”¨
                    window.testData = predictions;
                    
                } else {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`;
                dataDiv.style.display = 'none';
            }
        }

        function testTimeDistribution() {
            if (!window.testData) {
                alert('è¯·å…ˆæ‰§è¡ŒAPIæ•°æ®æµ‹è¯•');
                return;
            }

            const distributionDiv = document.getElementById('timeDistribution');
            const qualityDiv = document.getElementById('dataQuality');
            
            // æŒ‰æ—¶é—´æ®µåˆ†ç»„è‚¡ç¥¨
            const groupedStocks = timeSlots.map(() => []);
            let unclassified = [];
            
            window.testData.forEach(stock => {
                let classified = false;
                for (let i = 0; i < timeSlots.length; i++) {
                    if (isTimeInSlot(stock.sealTime, timeSlots[i])) {
                        groupedStocks[i].push(stock);
                        classified = true;
                        break;
                    }
                }
                if (!classified) {
                    unclassified.push(stock);
                }
            });

            // æ˜¾ç¤ºæ—¶é—´åˆ†å±‚ç»“æœ
            let distributionHtml = '';
            timeSlots.forEach((slot, index) => {
                const stocks = groupedStocks[index];
                distributionHtml += `
                    <div class="time-slot">
                        <div class="slot-header">${slot.label}<br>${slot.start}-${slot.end} (${stocks.length}åª)</div>
                        ${stocks.length > 0 ? 
                            stocks.slice(0, 3).map(stock => `
                                <div class="stock-item">
                                    ${stock.name} (${stock.code})<br>
                                    é€‰å‡º: ${stock.sealTime} | æ¶¨å¹…: ${stock.changePercent}%
                                </div>
                            `).join('') + (stocks.length > 3 ? `<div class="stock-item">...è¿˜æœ‰${stocks.length - 3}åª</div>` : '')
                            : '<div class="stock-item" style="color: #666;">æš‚æ— è‚¡ç¥¨</div>'
                        }
                    </div>
                `;
            });

            distributionDiv.innerHTML = distributionHtml;

            // ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š
            const totalStocks = window.testData.length;
            const classifiedStocks = totalStocks - unclassified.length;
            const classificationRate = (classifiedStocks / totalStocks * 100).toFixed(1);
            
            const avgChangePercent = (window.testData.reduce((sum, stock) => sum + (stock.changePercent || 0), 0) / totalStocks).toFixed(2);
            const avgPredictionScore = (window.testData.reduce((sum, stock) => sum + (stock.predictionScore || 0), 0) / totalStocks).toFixed(1);
            
            qualityDiv.innerHTML = `
                <h4>ğŸ“Š æ•°æ®è´¨é‡æŠ¥å‘Š</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <strong>æ€»è‚¡ç¥¨æ•°</strong><br>
                        <span style="font-size: 24px; color: #28a745;">${totalStocks}</span>åª
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <strong>æ—¶é—´åˆ†ç±»ç‡</strong><br>
                        <span style="font-size: 24px; color: #1976d2;">${classificationRate}%</span>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <strong>å¹³å‡æ¶¨å¹…</strong><br>
                        <span style="font-size: 24px; color: #f57c00;">${avgChangePercent}%</span>
                    </div>
                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                        <strong>å¹³å‡é¢„æµ‹åˆ†æ•°</strong><br>
                        <span style="font-size: 24px; color: #c2185b;">${avgPredictionScore}åˆ†</span>
                    </div>
                </div>
                ${unclassified.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong>âš ï¸ æœªåˆ†ç±»è‚¡ç¥¨ (${unclassified.length}åª):</strong><br>
                        ${unclassified.slice(0, 5).map(stock => `${stock.name}(${stock.sealTime})`).join(', ')}
                        ${unclassified.length > 5 ? '...' : ''}
                    </div>
                ` : ''}
            `;
        }

        function openMainPage() {
            window.open('http://localhost:8080/æ—¶é—´åˆ†å±‚æ¶¨åœé¢„æµ‹.html', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            testApiData();
        });
    </script>
</body>
</html>
